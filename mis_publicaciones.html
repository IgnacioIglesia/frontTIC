<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mis publicaciones ‚Äî La Otra Tribuna</title>
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="stylesheet" href="styles/user-widget.css" />
  <link rel="stylesheet" href="styles/notifications.css" />
  <link rel="icon" type="image/png" href="./assets/logo.png" />
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header id="siteHeader">
    <div class="top container">
      <div class="brand-wrap">
        <a href="index.html" class="logo-link" aria-label="Ir al inicio">
          <img class="logo" src="./assets/logo.png" alt="La Otra Tribuna">
        </a>
      </div>

      <div class="search">
        <input type="search" placeholder="Buscar club o pa√≠s‚Ä¶" autocomplete="off" />
      </div>

      <div class="header-messages" id="headerMessage">Gestion√° tus publicaciones</div>

      <div class="actions" style="display:flex;align-items:center;gap:12px;">
        <a id="loginBtn" href="login.html" class="btn-login">Iniciar sesi√≥n</a>

        <!-- Widget de usuario -->
        <div id="userWidget" class="user-widget hidden" aria-live="polite">
          <div id="userAvatar" class="user-avatar" title="Mi perfil"></div>
          <span id="greeting" class="user-greeting"></span>

          <div id="userMenu" class="user-menu hidden">
            <a href="perfil.html">üë§ Perfil</a>
            <a href="mis_publicaciones.html">üìä Mis Publicaciones</a>
            <a href="mis-pedidos.html">üßæ Mis pedidos</a>
            <a href="favoritos.html">‚≠ê Favoritos</a>
            <a href="#" id="logoutBtn">üö™ Cerrar sesi√≥n</a>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== SUBNAV ===== -->
    <nav class="subnav">
      <div class="container subnav-inner">
        <div class="subnav-left">
          <a href="#ubicacion" class="loc-link" id="openLocation">
            <svg class="loc-ic" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22s7-6.46 7-12a7 7 0 1 0-14 0c0 5.54 7 12 7 12Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <span class="loc-line" id="locText">Ingresa tu <strong>ubicaci√≥n</strong></span>
          </a>
        </div>

        <div class="subnav-center">
          <div class="has-submenu" id="catsDrop">
            <a href="index.html" class="subnav-link" id="catsLink" aria-haspopup="true" aria-expanded="false">
              Categor√≠as <span class="chev" aria-hidden="true">‚ñæ</span>
            </a>
            <div class="cat-submenu" id="catsMenu" role="menu" aria-label="Categor√≠as">
              <a href="index.html?cat=club#catalogo">Club</a>
              <a href="index.html?cat=seleccion#catalogo">Selecci√≥n</a>
              <a href="index.html?cat=retro#catalogo">Retro</a>
            </div>
          </div>
          <a href="ofertas.html" class="subnav-link">Ofertas</a>
          <a href="vender.html" class="subnav-link">Vender</a>
          <a href="rastrear.html" class="subnav-link">Rastrear Pedido</a>
        </div>

        <div class="subnav-right">
          <a href="favoritos.html" class="subnav-link">Favoritos</a>
          <a href="como-funciona.html" class="subnav-link">C√≥mo funciona</a>
          <a href="autenticidad.html" class="subnav-link">Autenticidad</a>
          <a href="ayuda.html" class="subnav-link">Ayuda</a>
        </div>
      </div>
    </nav>
  </header>

  <!-- ===== CONTENIDO ===== -->
  <main class="container">
    <div class="info-wrap" style="padding:20px">
      <h1 style="margin-bottom:6px">Mis publicaciones</h1>
      <p class="lead">Ac√° pod√©s ver, comparar y administrar las publicaciones que creaste.</p>

      <div id="pubGrid" class="favs-grid" style="margin-top:12px"></div>
      <p id="pubEmpty" class="muted" style="text-align:center; display:none; margin:18px 0">
        A√∫n no publicaste nada.
      </p>
    </div>
  </main>

  <!-- ===== ‚ûä SUPABASE init + HEADER (una sola vez) ===== -->
  <script type="module" id="sb-init">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // Declaraci√≥n √∫nica
    const SUPABASE_URL = 'https://imexctmcesopdfdebsgo.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZXhjdG1jZXNvcGRmZGVic2dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDczMDIsImV4cCI6MjA3NDg4MzMwMn0.g1lziVKAuUvMEOkYxJhe2D2z8PlwGJ6xcXo_SSpTj7Q'

    // Cliente compartido global
    window.sb = window.sb ?? createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    
    const loginBtn   = document.getElementById('loginBtn')
    const userWidget = document.getElementById('userWidget')
    const userMenu   = document.getElementById('userMenu')
    const logoutBtn  = document.getElementById('logoutBtn')
    const avatarEl   = document.getElementById('userAvatar')
    const greetEl    = document.getElementById('greeting')

    const initialsFrom = (nombre='', apellido='', email='')=>{
      const n = (nombre||'').trim().split(/\s+/)[0]||''
      const a = (apellido||'').trim().split(/\s+/)[0]||''
      const ini = (n[0]||'') + (a[0]||'')
      return (ini || (email[0]||'?')).toUpperCase()
    }
    const firstNameFrom = (nombre='', email='')=>{
      const n = (nombre||'').trim().split(/\s+/)[0]
      return n || (email||'').split('@')[0]
    }

    async function refreshHeader(){
      const { data: { session } } = await supabase.auth.getSession()
      if (!session){
        userWidget.classList.add('hidden')
        loginBtn.classList.remove('hidden')
        return
      }
      let nombre = session.user.user_metadata?.nombre || ''
      let apellido = session.user.user_metadata?.apellido || ''
      let email = session.user.email || ''
      try{
        const { data: perfil } = await supabase
          .from('usuario')
          .select('nombre,apellido,email')
          .eq('id_auth', session.user.id)
          .maybeSingle()
        if (perfil){
          nombre = perfil.nombre ?? nombre
          apellido = perfil.apellido ?? apellido
          email = perfil.email ?? email
        }
      }catch(_){}

      avatarEl.textContent = initialsFrom(nombre, apellido, email)
      greetEl.textContent  = `Hola, ${firstNameFrom(nombre, email)}!`
      loginBtn.classList.add('hidden')
      userWidget.classList.remove('hidden')
    }

    userWidget.addEventListener('click', (e)=>{
      if(e.target.closest('#userMenu')) return
      userMenu.classList.toggle('hidden')
    })
    document.addEventListener('click', (e)=>{
      if(!userWidget.contains(e.target)){ userMenu.classList.add('hidden') }
    })
    logoutBtn?.addEventListener('click', async (e)=>{
      e.preventDefault()
      await supabase.auth.signOut()
      location.reload()
    })

    await refreshHeader()
    supabase.auth.onAuthStateChange(()=> refreshHeader())
  </script>

  <!-- ===== ‚ûã L√ìGICA: Listar y borrar publicaciones (reusa window.sb) ===== -->
  <script type="module">
    const supabase = window.sb
    const TABLE_NAME = 'publicaciones'   // cambi√° si tu tabla se llama distinto
    const PLACEHOLDER = 'https://placehold.co/600x750?text=Camiseta'
    const uy = new Intl.NumberFormat('es-UY',{style:'currency',currency:'UYU',maximumFractionDigits:0})

    const grid  = document.getElementById('pubGrid')
    const empty = document.getElementById('pubEmpty')

    // Redirige si no hay sesi√≥n
    const { data: { session } } = await supabase.auth.getSession()
    if (!session) location.href = 'login.html?next=mis_publicaciones.html'

    async function loadMyPubs() {
      grid.innerHTML = ''
      empty.style.display = 'none'

      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select('id,titulo,club,categoria,precio,imagen_url,created_at')
        .eq('vendedor_id', session.user.id)
        .order('created_at', { descending: true })

      if (error) {
        console.error(error)
        grid.innerHTML = `<div class="muted">Ocurri√≥ un error al cargar tus publicaciones.</div>`
        return
      }

      if (!data?.length) { empty.style.display = 'block'; return }

      for (const p of data) {
        const card = document.createElement('article')
        card.className = 'card'
        card.dataset.id = p.id
        card.innerHTML = `
          <div class="media">
            <img src="${p.imagen_url || PLACEHOLDER}" alt="${p.titulo || 'Camiseta'}"
                 onerror="this.src='${PLACEHOLDER}'">
          </div>
          <div class="body">
            <div class="meta">
              <div>
                <div style="font-weight:700">${p.titulo || 'Sin t√≠tulo'}</div>
                <div class="muted">${p.club || '‚Äî'} ‚Ä¢ ${p.categoria || '‚Äî'}</div>
              </div>
              <div class="price">${p.precio!=null ? uy.format(p.precio) : '‚Äî'}</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <a class="btn ghost" href="vender.html?edit=${p.id}">Editar</a>
              <button class="btn danger" data-act="delete" data-id="${p.id}">Borrar</button>
            </div>
          </div>`
        grid.appendChild(card)
      }
    }

    async function deletePub(id, btnEl) {
      if (!confirm('¬øSeguro que quer√©s borrar esta publicaci√≥n? Esta acci√≥n no se puede deshacer.')) return
      btnEl.disabled = true; btnEl.textContent = 'Borrando‚Ä¶'
      const card = btnEl.closest('.card'); card.style.opacity = .6

      const { error } = await supabase.from(TABLE_NAME).delete().eq('id', id)
      if (error) {
        alert('No se pudo borrar. Intentalo de nuevo.')
        console.error(error)
        btnEl.disabled = false; btnEl.textContent = 'Borrar'; card.style.opacity = 1
        return
      }

      card.remove()
      if (!grid.children.length) empty.style.display = 'block'
    }

    grid.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act="delete"]')
      if (!btn) return
      deletePub(Number(btn.dataset.id), btn)
    })

    await loadMyPubs()
  </script>

  <!-- ‚úÖ NOTIFICACIONES -->
  <script type="module" src="scripts/notifications.js"></script>
</body>
</html>