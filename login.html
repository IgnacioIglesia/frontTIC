<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iniciar sesión — La Otra Tribuna</title>
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="stylesheet" href="styles/mobile.css" />
  <script src="scripts/mobile-nav.js" defer></script>
  <link rel="stylesheet" href="styles/user-widget.css" />
  <link rel="icon" type="image/png" href="./assets/logo.png" />
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header id="siteHeader">
    <div class="top container">
      <div class="brand-wrap">
        <a href="index.html" class="logo-link" aria-label="Ir al inicio">
          <img class="logo" src="./assets/logo.png" alt="La Otra Tribuna" />
        </a>
      </div>
      <div class="search">
        <input type="search" placeholder="Buscar club o país…" />
      </div>
      <div class="header-messages">Iniciá sesión para comprar y vender</div>
    </div>

    <button class="burger" aria-expanded="false" aria-controls="mnav" aria-label="Abrir menú">
      <span>≡</span>
    </button>

    <!-- ===== SUBNAV ===== -->
    <nav class="subnav">
      <div class="container subnav-inner">
        <div class="subnav-left">
          <a href="#ubicacion" class="loc-link" id="openLocation">
            <svg class="loc-ic" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22s7-6.46 7-12a7 7 0 1 0-14 0c0 5.54 7 12 7 12Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <span class="loc-line" id="locText">Ingresa tu <strong>ubicación</strong></span>
          </a>
        </div>
        <div class="subnav-center">
          <div class="has-submenu" id="catsDrop">
            <a href="index.html" class="subnav-link">Categorías ▾</a>
            <div class="cat-submenu">
              <a href="index.html?cat=club#catalogo">Club</a>
              <a href="index.html?cat=seleccion#catalogo">Selección</a>
              <a href="index.html?cat=retro#catalogo">Retro</a>
            </div>
          </div>
          <a href="ofertas.html" class="subnav-link">Ofertas</a>
          <a href="vender.html" class="subnav-link">Vender</a>
          <a href="rastrear.html" class="subnav-link">Rastrear Pedido</a>
        </div>
        <div class="subnav-right">
          <a href="favoritos.html" class="subnav-link">Favoritos</a>
          <a href="como-funciona.html" class="subnav-link">Cómo funciona</a>
          <a href="autenticidad.html" class="subnav-link">Autenticidad</a>
          <a href="ayuda.html" class="subnav-link">Ayuda</a>
        </div>
      </div>
    </nav>

    <!-- ===== MENÚ MÓVIL ===== -->
    <nav id="mnav" class="mnav" role="dialog" aria-modal="true" aria-label="Menú">
      <div class="mnav-head">
        <strong>Menú</strong>
        <button type="button" class="close-mnav" aria-label="Cerrar">✕</button>
      </div>
      <div class="mnav-search">
        <input id="mq" type="search" placeholder="Buscar camisetas…" autocomplete="off" />
        <div id="msearchMenu" class="search-menu" hidden></div>
      </div>
      <div class="mnav-links">
        <a href="index.html">Inicio</a>
        <a href="ofertas.html">Ofertas</a>
        <a href="vender.html">Vender</a>
        <a href="rastrear.html">Rastrear Pedido</a>
        <a href="favoritos.html">Favoritos</a>
        <a href="como-funciona.html">Cómo funciona</a>
        <a href="autenticidad.html">Autenticidad</a>
        <a href="ayuda.html">Ayuda</a>
      </div>
    </nav>
  </header>

  <!-- ===== MODAL UBICACIÓN ===== -->
  <div id="overlay" class="overlay"></div>
  <div id="locationModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="locTitle">Elige dónde recibir tus compras</h3>
        <button class="modal-close" id="closeLocation" aria-label="Cerrar">✕</button>
      </div>
      <p class="muted" style="margin:0 0 12px">
        Podrás ver costos y tiempos de entrega precisos en todo lo que busques.
      </p>

      <form id="locForm" class="loc-form" autocomplete="off">
        <div class="field">
          <label for="departamento">Departamento</label>
          <select id="departamento" required>
            <option value="" selected>Elija una opción</option>
          </select>
        </div>
        <div class="field">
          <label for="localidad">Localidad</label>
          <select id="localidad" required disabled>
            <option value="" selected>Elija una opción</option>
          </select>
        </div>
        <div class="actions-row">
          <button type="button" class="btn" id="cancelLoc">Cancelar</button>
          <button type="submit" class="btn primary" id="acceptLoc" disabled>Aceptar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== LOGIN FORM ===== -->
  <main class="track-full">
    <div class="track-card">
      <div class="track-title">
        <img src="./assets/imagen.png" alt="Logo" style="height:32px" />
        <h2>Iniciar Sesión</h2>
      </div>

      <form id="loginForm" class="track-form">
        <div class="field">
          <label for="email">Email</label>
          <input id="email" type="email" required placeholder="tucorreo@ejemplo.com" />
        </div>

        <div class="field">
          <label for="password">Contraseña</label>
          <input id="password" type="password" required placeholder="************" />
        </div>

        <button type="submit" class="btn primary">Ingresar</button>
      </form>

      <p class="muted" style="margin-top:20px;font-size:14px;">
        ¿Aún no tenés cuenta?
        <a href="registro.html" style="color:var(--brand);font-weight:600;text-decoration:none;">Registrate acá</a>
      </p>

      <p id="msg" class="muted" style="margin-top:10px;"></p>
    </div>
  </main>

  <!-- ===== SCRIPT UBICACIÓN ===== -->
  <script src="scripts/uy-depts.js"></script>
  <script>
    const LOCATION_KEY = 'lot_location';
    const overlay = document.getElementById('overlay');
    const locationModal = document.getElementById('locationModal');
    const openLocationBtn = document.getElementById('openLocation');
    const closeLocationBtn = document.getElementById('closeLocation');
    const cancelLocBtn = document.getElementById('cancelLoc');
    const deptSel = document.getElementById('departamento');
    const locSel  = document.getElementById('localidad');
    const acceptLocBtn = document.getElementById('acceptLoc');
    const locText = document.getElementById('locText');
    const DEPTS = window.UY_DEPTS || {"Montevideo":["Montevideo"]};

    function fillDept(){ 
      Object.keys(DEPTS).forEach(d => deptSel.append(new Option(d,d))); 
    }
    
    function renderLocationText(){
      const raw = localStorage.getItem(LOCATION_KEY);
      if(!raw){ 
        locText.innerHTML = 'Ingresa tu <strong>ubicación</strong>'; 
        return; 
      }
      try{ 
        const {loc} = JSON.parse(raw); 
        locText.textContent = `Enviar a ${loc}`;  // ← CORREGIDO: textContent en lugar de innerHTML
      }
      catch{ 
        locText.innerHTML = 'Ingresa tu <strong>ubicación</strong>'; 
      }
    }

    function openLocationModal() {
      locationModal.classList.add('open');
      overlay.classList.add('show');
      document.body.classList.add('modal-open');
    }
    
    function closeLocationModal() {
      locationModal.classList.remove('open');
      overlay.classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    openLocationBtn.addEventListener('click', e=>{ 
      e.preventDefault(); 
      openLocationModal(); 
    });
    
    closeLocationBtn.addEventListener('click', closeLocationModal);
    cancelLocBtn.addEventListener('click', closeLocationModal);
    overlay.addEventListener('click', closeLocationModal);

    deptSel.addEventListener('change', ()=>{
      locSel.innerHTML = '<option value="">Elija una opción</option>';
      if(!deptSel.value){ 
        locSel.disabled = true; 
        acceptLocBtn.disabled = true; 
        return; 
      }
      (DEPTS[deptSel.value]||[]).forEach(l => locSel.append(new Option(l,l)));
      locSel.disabled = false; 
      acceptLocBtn.disabled = true;
    });
    
    locSel.addEventListener('change', ()=>{ 
      acceptLocBtn.disabled = !locSel.value; 
    });

    document.getElementById('locForm').addEventListener('submit', e=>{
      e.preventDefault();
      localStorage.setItem(LOCATION_KEY, JSON.stringify({dept:deptSel.value, loc:locSel.value}));
      renderLocationText();
      closeLocationModal();
    });

    fillDept(); 
    renderLocationText();
  </script>

  <!-- ===== SUPABASE LOGIN ===== -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = 'https://imexctmcesopdfdebsgo.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZXhjdG1jZXNvcGRmZGVic2dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDczMDIsImV4cCI6MjA3NDg4MzMwMn0.g1lziVKAuUvMEOkYxJhe2D2z8PlwGJ6xcXo_SSpTj7Q'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const form = document.getElementById('loginForm')
    const msg = document.getElementById('msg')

    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      msg.textContent = 'Iniciando sesión...'

      const email = document.getElementById('email').value
      const password = document.getElementById('password').value

      const { data, error } = await supabase.auth.signInWithPassword({ email, password })

      if (error) {
        if (error.message.includes("Invalid login credentials")) {
          msg.textContent = "El email o la contraseña son incorrectos."
        } else if (error.message.includes("Email not confirmed")) {
          msg.textContent = "Tu email aún no fue confirmado. Revisá tu bandeja."
        } else {
          msg.textContent = "Ocurrió un error: " + error.message
        }
        msg.style.color = "red"
      } else {
        msg.textContent = '¡Login correcto! Redirigiendo...'
        msg.style.color = 'green'
        setTimeout(() => { window.location.href = 'index.html' }, 1200)
      }
    })
  </script>
</body>
</html>