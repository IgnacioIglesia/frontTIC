<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Otra Tribuna ‚Äî Tienda de camisetas</title>
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="stylesheet" href="styles/user-widget.css" />
  <link rel="icon" type="image/png" href="./assets/logo.png" />

  <!-- === Estilos m√≠nimos para el dropdown de notificaciones === -->
  <style>
    .pill { position: relative; }
    .pill span { margin-left: .25rem; font-weight: 600; }
    .pill.has-notifications { animation: bump .3s ease; }
    @keyframes bump { 0%{transform:scale(1)} 50%{transform:scale(1.08)} 100%{transform:scale(1)} }

    .not-dd-wrapper { position: relative; }
    .not-dropdown{
      position:absolute; right:0; top:calc(100% + 10px);
      width:340px; max-height:70vh; overflow:auto;
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.12); z-index:50;
    }
    .not-dd-header{ display:flex; justify-content:space-between; align-items:center; gap:8px;
      padding:6px 8px 10px; border-bottom:1px solid #f0f0f0; margin-bottom:8px; }
    .not-dd-list{ display:flex; flex-direction:column; gap:10px; }
    .not-dd-empty{ text-align:center; color:#6b7280; padding:18px 8px; }
    .not-item{
      display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:start;
      padding:10px; border-radius:10px; border:1px solid #eef0f2; background:#fafafa; cursor:pointer;
    }
    .not-item.unread{ background:#f7fbff; border-color:#e5f0ff; }
    .not-item .title{ font-weight:600; margin-bottom:2px; }
    .not-item .desc{ color:#6b7280; font-size:13px; }
    .not-item .time{ color:#6b7280; font-size:12px; margin-left:8px; white-space:nowrap; }

    /* Bot√≥n papelera en cada notificaci√≥n */
    .not-item .right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }
    .not-del {
      border: 1px solid #e5e7eb;
      background: #fff;
      font-size: 13px;
      padding: 4px 6px;
      border-radius: 8px;
      cursor: pointer;
      line-height: 1;
    }
    .not-del:hover { background: #f9fafb; }
    .not-del:active { transform: scale(0.98); }
  </style>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header id="siteHeader">
    <div class="top container">
      <div class="brand-wrap">
        <a href="index.html" class="logo-link" aria-label="Ir al inicio">
          <img class="logo" src="./assets/logo.png" alt="La Otra Tribuna" />
        </a>
      </div>

      <div class="search">
        <input id="q" type="search" placeholder="Buscar club o pa√≠s‚Ä¶" autocomplete="off" />
        <div id="searchMenu" class="search-menu" hidden></div>
      </div>

      <div class="header-messages" id="headerMessage">Env√≠os seguros y r√°pidos</div>

      <div class="actions" style="display:flex;align-items:center;gap:12px;">
        <!-- Bot√≥n por defecto (si no hay sesi√≥n) -->
        <a id="loginBtn" href="login.html" class="btn-login">Iniciar sesi√≥n</a>

        <!-- Widget de usuario (aparece con sesi√≥n) -->
        <div id="userWidget" class="user-widget hidden" aria-live="polite">
          <div id="userAvatar" class="user-avatar" title="Mi perfil"></div>
          <span id="greeting" class="user-greeting"></span>
          <div id="userMenu" class="user-menu hidden">
            <a href="perfil.html">üë§ Perfil</a>
            <a href="#" id="logoutBtn">üö™ Cerrar sesi√≥n</a>
          </div>
        </div>

        <!-- === Notificaciones (campana + dropdown) === -->
        <div class="not-dd-wrapper">
          <button class="pill" id="notBtn" aria-label="Abrir notificaciones">üîî<span id="notCount">0</span></button>
          <div id="notDropdown" class="not-dropdown" hidden>
            <div class="not-dd-header">
              <strong>Notificaciones</strong>
              <a href="#" id="markAllRead" class="muted">Marcar todas como le√≠das</a>
            </div>
            <div id="notList" class="not-dd-list"></div>
          </div>
        </div>

        <!-- Botones favoritos / carrito -->
        <button class="pill" id="favBtn" aria-label="Abrir favoritos">‚ù§Ô∏è<span id="favCount">0</span></button>
        <button class="pill" id="cartBtn" aria-label="Abrir carrito">üõí <span id="cartCount">0</span></button>
      </div>
    </div>

    <!-- ===== SUBNAV ===== -->
    <nav class="subnav">
      <div class="container subnav-inner">
        <div class="subnav-left">
          <a href="#ubicacion" class="loc-link" id="openLocation">
            <svg class="loc-ic" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22s7-6.46 7-12a7 7 0 1 0-14 0c0 5.54 7 12 7 12Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <span class="loc-line" id="locText">Enviar a <strong>Montevideo</strong></span>
          </a>
        </div>

        <div class="subnav-center">
          <div class="has-submenu" id="catsDrop">
            <a href="#categorias" class="subnav-link" id="catsLink" aria-haspopup="true" aria-expanded="false">
              Categor√≠as <span class="chev" aria-hidden="true">‚ñæ</span>
            </a>
            <div class="cat-submenu" id="catsMenu" role="menu" aria-label="Categor√≠as">
              <a href="#" data-cat="Club">Club</a>
              <a href="#" data-cat="Selecci√≥n">Selecci√≥n</a>
              <a href="#" data-cat="Retro">Retro</a>
            </div>
          </div>
          <a href="ofertas.html" class="subnav-link">Ofertas</a>
          <a href="vender.html" class="subnav-link">Vender</a>
          <a href="rastrear.html" class="subnav-link">Rastrear Pedido</a>
        </div>

        <div class="subnav-right">
          <a href="favoritos.html" class="subnav-link" id="favLink">Favoritos</a>
          <a href="como-funciona.html" class="subnav-link">C√≥mo funciona</a>
          <a href="autenticidad.html" class="subnav-link">Autenticidad</a>
          <a href="ayuda.html" class="subnav-link">Ayuda</a>
        </div>
      </div>
    </nav>
  </header>

  <!-- Overlay compartido -->
  <div id="overlay" class="overlay"></div>

  <!-- ===== Modal de ubicaci√≥n ===== -->
  <div id="locationModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="locTitle" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="locTitle">Elige d√≥nde recibir tus compras</h3>
        <button class="modal-close" id="closeLocation" aria-label="Cerrar">‚úï</button>
      </div>
      <p class="muted" style="margin:0 0 12px">Podr√°s ver costos y tiempos de entrega precisos en todo lo que busques.</p>

      <form id="locForm" class="loc-form" autocomplete="off">
        <div class="field">
          <label for="departamento">Departamento</label>
          <select id="departamento" required>
            <option value="" selected>Elija una opci√≥n</option>
          </select>
        </div>
        <div class="field">
          <label for="localidad">Localidad</label>
          <select id="localidad" required disabled>
            <option value="" selected>Elija una opci√≥n</option>
          </select>
        </div>
        <div class="actions-row">
          <button type="button" class="btn" id="cancelLoc">Cancelar</button>
          <button type="submit" class="btn primary" id="acceptLoc" disabled>Aceptar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Paneles laterales ===== -->
  <aside id="cartMenu" class="cart-menu">
    <div class="cart-header">
      <h3>Tu carrito</h3>
      <button id="closeCart" class="close-btn">‚úï</button>
    </div>
    <div id="cartItems" class="cart-items">
      <p class="muted">Tu carrito est√° vac√≠o</p>
    </div>
    <div class="cart-footer">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span>Total:</span>
        <strong id="cartTotal">$ 0</strong>
      </div>
      <button class="btn primary checkout-btn">Finalizar compra</button>
    </div>
  </aside>

  <aside id="favMenu" class="cart-menu">
    <div class="cart-header">
      <h3>Favoritos</h3>
      <button id="closeFav" class="close-btn">‚úï</button>
    </div>
    <div id="favItems" class="cart-items">
      <p class="muted">A√∫n no agregaste favoritos</p>
    </div>
    <div class="cart-footer">
      <button class="btn primary checkout-btn" id="favGoCart">Pasar todo al carrito</button>
    </div>
  </aside>

  <!-- ===== HERO ===== -->
  <main>
    <section class="hero">
      <button class="hero-nav prev" aria-label="Imagen anterior">‚Äπ</button>
      <button class="hero-nav next" aria-label="Imagen siguiente">‚Ä∫</button>
      <div class="copy">
        <h1>El mercado de las camisetas</h1>
        <p class="hero-sub">Public√°, compr√° y vend√© entre hinchas de verdad.</p>
      </div>
    </section>

    <div class="container">
      <section id="catalogo">
        <h2>Cat√°logo</h2>
        <p class="muted">Resultados: <span id="count">0</span></p>

        <div class="filters">
          <select id="club"><option value="">Todos los clubes</option></select>
          <select id="pais"><option value="">Todos los pa√≠ses</option></select>
          <select id="categoria">
            <option value="">Todas las categor√≠as</option>
            <option>Club</option>
            <option>Selecci√≥n</option>
            <option>Retro</option>
          </select>
          <div class="filter-price">
            <label class="muted" for="price">Precio m√°x.: <span id="priceLabel"></span></label>
            <input id="price" class="range" type="range" min="1500" max="4000" step="50" value="4000" />
          </div>
        </div>

        <div id="grid" class="grid"></div>
      </section>

      <footer>¬©Ô∏è <span id="year"></span> La Otra Tribuna.</footer>
    </div>
  </main>

  <!-- ===== MODAL PRODUCTO ===== -->
  <div id="productModal" class="modal product-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card product-card">
      <button class="modal-close" id="closeProduct" aria-label="Cerrar">‚úï</button>

      <div class="product-grid">
        <div class="product-media">
          <img id="pdImage" alt="Imagen de la publicaci√≥n" />
        </div>

        <div class="product-info">
          <h3 id="pdTitle" class="pd-title"></h3>
          <div class="pd-price" id="pdPrice"></div>

          <dl class="pd-meta">
            <div><dt>Categor√≠a</dt><dd id="pdCategoria"></dd></div>
            <div><dt>Talle</dt><dd id="pdTalle"></dd></div>
            <div><dt>Condici√≥n</dt><dd id="pdCondicion"></dd></div>
            <div><dt>Autenticidad</dt><dd id="pdAuth"></dd></div>
            <div><dt>Stock</dt><dd id="pdStock"></dd></div>
          </dl>

          <p id="pdDesc" class="pd-desc"></p>

          <div class="pd-seller">
            <div id="pdAvatar" class="user-avatar"></div>
            <div>
              <div class="pd-seller-name" id="pdSeller">Vendedor</div>
              <div class="muted" id="pdSellerEmail"></div>
            </div>
          </div>

          <div class="pd-actions">
            <button class="btn primary" id="pdAddCart">Agregar al carrito</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== L√ìGICA APP ===== -->
  <script>
    let DATA = [];
    const PLACEHOLDER = 'https://placehold.co/600x750?text=Camiseta';
    const uy = new Intl.NumberFormat('es-UY',{style:'currency',currency:'UYU',maximumFractionDigits:0});
    const qs = s => document.querySelector(s);

    const grid = qs('#grid'), count = qs('#count');
    const price = qs('#price'), priceLabel = qs('#priceLabel');
    const clubSel = qs('#club'), paisSel = qs('#pais'), catSel = qs('#categoria');
    const q = qs('#q');
    document.getElementById('year').textContent = new Date().getFullYear();

    // Preseleccionar categor√≠a desde ?cat=
    const params = new URLSearchParams(window.location.search);
    const catParam = (params.get('cat') || '').toLowerCase();
    const CAT_MAP = { club: 'Club', seleccion: 'Selecci√≥n', retro: 'Retro' };
    if (CAT_MAP[catParam]) catSel.value = CAT_MAP[catParam];

    // ===== FAVORITOS PERSISTENTES =====
    const favorites = new Set(JSON.parse(localStorage.getItem('lot_favorites') || '[]'));
    function saveFavorites(){ localStorage.setItem('lot_favorites', JSON.stringify([...favorites])); }

    // ===== CARRITO PERSISTENTE =====
    const cart = new Map(Object.entries(JSON.parse(localStorage.getItem('lot_cart') || '{}')).map(([k,v]) => [+k, v]));
    function saveCart(){ localStorage.setItem('lot_cart', JSON.stringify(Object.fromEntries(cart))); }

    // ======== NOTIFICACIONES (persistentes) ========
    const notifications = JSON.parse(localStorage.getItem('lot_notifications') || '[]');

    // Badges
    function updateFavBadge(){
      const favCountBadge = document.getElementById('favCount');
      if (favCountBadge) favCountBadge.textContent = favorites.size;
    }
    function updateCartBadge(){
      const cartCountBadge = document.getElementById('cartCount');
      if (cartCountBadge) {
        let totalQty = 0; cart.forEach(qty => totalQty += qty);
        cartCountBadge.textContent = totalQty;
      }
    }
    function updateNotBadge(){
      const el = document.getElementById('notCount');
      const unread = notifications.filter(n=>!n.read).length;
      el.textContent = unread;
      const btn = document.getElementById('notBtn');
      if (unread>0) btn.classList.add('has-notifications'); else btn.classList.remove('has-notifications');
    }

    // ===== PANEL CARRITO =====
    const cartBtn = document.getElementById('cartBtn');
    const closeCart = document.getElementById('closeCart');
    const cartItemsDiv = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    const cartMenu = document.getElementById('cartMenu');
    const overlay = document.getElementById('overlay'); /* <-- referencia usada por paneles/modales */

    function showOverlay(){ overlay.classList.add('show'); }
    function hideOverlay(){ overlay.classList.remove('show'); }
    function hideOverlayIfIdle(){
      const m = document.getElementById('locationModal');
      if(!document.querySelector('.cart-menu.open') && !m.classList.contains('open')) hideOverlay();
    }
    function openCart(){ cartMenu.classList.add('open'); showOverlay(); }
    function closeCartMenu(){ cartMenu.classList.remove('open'); hideOverlayIfIdle(); }

    cartBtn.addEventListener('click', openCart);
    closeCart.addEventListener('click', closeCartMenu);

    function updateCartUI(){
      let totalPrice = 0;
      cartItemsDiv.innerHTML = '';
      if (cart.size === 0) {
        cartItemsDiv.innerHTML = '<p class="muted">Tu carrito est√° vac√≠o</p>';
        cartTotal.textContent = '$ 0'; updateCartBadge(); return;
      }
      cart.forEach((qty, id) => {
        const prod = DATA.find(p => p.id === id);
        if (prod) {
          const itemTotal = prod.precio * qty; totalPrice += itemTotal;
          const row = document.createElement('div');
          row.className = 'cart-item';
          row.innerHTML = `
            <img src="${prod.img}" alt="${prod.nombre}" onerror="this.src='${PLACEHOLDER}'">
            <div class="meta">
              <strong>${prod.nombre}</strong>
              <span class="muted">${uy.format(prod.precio)} c/u</span>
              <div class="qty">
                <button class="icon" data-act="dec" data-id="${id}">‚àí</button>
                <span>${qty}</span>
                <button class="icon" data-act="inc" data-id="${id}">Ôºã</button>
                <button class="icon" data-act="rm" data-id="${id}" title="Quitar">üóë</button>
              </div>
            </div>
            <div><strong>${uy.format(itemTotal)}</strong></div>`;
          cartItemsDiv.appendChild(row);
        }
      });
      cartTotal.textContent = uy.format(totalPrice); updateCartBadge();
    }

    cartItemsDiv.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.icon'); if (!btn) return;
      const id = Number(btn.dataset.id); const act = btn.dataset.act;
      if (act === 'inc') cart.set(id, (cart.get(id) || 0) + 1);
      else if (act === 'dec') { const current = cart.get(id) || 0; if (current > 1) cart.set(id, current - 1); else cart.delete(id); }
      else if (act === 'rm') cart.delete(id);
      saveCart(); updateCartUI();
    });

    // Favoritos
    const favBtn = document.getElementById('favBtn');
    const favMenu = document.getElementById('favMenu');
    const closeFav = document.getElementById('closeFav');
    const favItemsDiv = document.getElementById('favItems');
    const favGoCartBtn = document.getElementById('favGoCart');

    function openFav(){ favMenu.classList.add('open'); showOverlay(); }
    function closeFavMenu(){ favMenu.classList.remove('open'); hideOverlayIfIdle(); }

    favBtn.addEventListener('click', openFav);
    closeFav.addEventListener('click', closeFavMenu);
    favGoCartBtn.addEventListener('click', ()=>{
      favorites.forEach(id=>{ const prod = DATA.find(p=>p.id===id); if(!prod) return; cart.set(id, (cart.get(id) || 0) + 1); });
      saveCart(); updateCartUI(); openCart();
    });

    function renderNotifications() {
      notList.innerHTML = '';

      if (!notifications.length) {
        notList.innerHTML = `<div class="not-dd-empty">
          <div style="font-size:22px; margin-bottom:6px;">üîî</div>
          No tienes notificaciones
        </div>`;
        updateNotBadge();
        return;
      }

      notifications.forEach((not, index) => {
        const el = document.createElement('div');
        el.className = `not-item ${not.read ? '' : 'unread'}`;
        el.innerHTML = `
          <div class="icon">üü°</div>
          <div>
            <div class="title">${not.title}</div>
            <div class="desc">${not.message}</div>
          </div>
          <div class="right">
            <div class="time">${formatTime(not.timestamp)}</div>
            <button class="not-del" data-idx="${index}" aria-label="Borrar notificaci√≥n" title="Borrar">üóë</button>
          </div>
        `;

        // Marcar le√≠da al hacer click en el item (menos en la papelera)
        el.addEventListener('click', (e) => {
          if (e.target.closest('.not-del')) return; // no marcar si clicke√≥ papelera
          notifications[index].read = true;
          localStorage.setItem('lot_notifications', JSON.stringify(notifications));
          updateNotBadge();
          renderNotifications();
        });

        notList.appendChild(el);
      });

      // Borrar individual (delegado)
      notList.querySelectorAll('.not-del').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation(); // evita marcar como le√≠da
          const idx = Number(btn.dataset.idx);
          notifications.splice(idx, 1);
          localStorage.setItem('lot_notifications', JSON.stringify(notifications));
          updateNotBadge();
          renderNotifications();
        });
      });
    }

    favItemsDiv.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.icon'); if(!btn) return;
      const id = Number(btn.dataset.id), act = btn.dataset.act;
      const prod = DATA.find(p => p.id === id); if(!prod) return;
      if(act==='addcart'){ cart.set(id, (cart.get(id) || 0) + 1); saveCart(); updateCartUI(); openCart(); }
      else if(act==='rmfav'){ favorites.delete(id); saveFavorites(); updateFavBadge(); renderFavMenu(); updateGridFavIcons(); }
    });

    // ======== NOTIFICACIONES: Dropdown ========
    const notBtn = document.getElementById('notBtn');
    const notDropdown = document.getElementById('notDropdown');
    const notList = document.getElementById('notList');
    const markAllReadBtn = document.getElementById('markAllRead');

    function formatTime(ts){
      const now=new Date(), diff=now - new Date(ts);
      const m=Math.floor(diff/60000), h=Math.floor(diff/3600000), d=Math.floor(diff/86400000);
      if(m<1) return 'Ahora mismo'; if(m<60) return `Hace ${m} min`; if(h<24) return `Hace ${h} h`;
      if(d<7) return `Hace ${d} d`; return new Date(ts).toLocaleDateString();
    }
    function renderNotifications(){
      notList.innerHTML='';
      if(!notifications.length){
        notList.innerHTML = `<div class="not-dd-empty"><div style="font-size:22px;margin-bottom:6px">üîî</div>No tienes notificaciones</div>`;
        return;
      }
      notifications.forEach((n,i)=>{
        const el=document.createElement('div'); el.className=`not-item ${n.read?'':'unread'}`;
        el.innerHTML = `
          <div class="icon">üü°</div>
          <div><div class="title">${n.title}</div><div class="desc">${n.message}</div></div>
          <div class="time">${formatTime(n.timestamp)}</div>`;
        el.addEventListener('click', ()=>{
          notifications[i].read = true;
          localStorage.setItem('lot_notifications', JSON.stringify(notifications));
          updateNotBadge(); renderNotifications();
        });
        notList.appendChild(el);
      });
    }
    function openNotDD(){ notDropdown.hidden=false; }
    function closeNotDD(){ notDropdown.hidden=true; }
    notBtn.addEventListener('click',(e)=>{ e.stopPropagation(); if(notDropdown.hidden) openNotDD(); else closeNotDD(); });
    document.addEventListener('click',(e)=>{ if(!notDropdown.hidden && !e.target.closest('.not-dd-wrapper')) closeNotDD(); });
    markAllReadBtn.addEventListener('click',(e)=>{ e.preventDefault(); notifications.forEach(n=>n.read=true); localStorage.setItem('lot_notifications', JSON.stringify(notifications)); updateNotBadge(); renderNotifications(); });

    // Muestras iniciales (solo si no hay nada guardado)
    (function seedNotifs(){
      if (notifications.length) return;
      const sample = [
        { title:"¬°Bienvenido a La Otra Tribuna!", message:"Explor√° nuestro cat√°logo de camisetas √∫nicas.", timestamp:new Date(Date.now()-1000*60*5).toISOString(), read:false },
        { title:"Oferta especial", message:"Env√≠o gratis en compras superiores a $2000.", timestamp:new Date(Date.now()-1000*60*60*2).toISOString(), read:false },
        { title:"Nuevas camisetas", message:"Secci√≥n Retro actualizada.", timestamp:new Date(Date.now()-1000*60*60*24).toISOString(), read:true }
      ];
      notifications.push(...sample);
      localStorage.setItem('lot_notifications', JSON.stringify(notifications));
    })();

    // Render cat√°logo
    function render(){
      priceLabel.textContent = uy.format(Number(price.value));
      const term = (q.value||'').toLowerCase();
      const maxP = Number(price.value);
      const club = clubSel.value, pais = paisSel.value, cat = catSel.value;

      const items = DATA.filter(p =>
        p.precio <= maxP &&
        (!club || p.club===club) &&
        (!pais || p.pais===pais) &&
        (!cat || p.categoria===cat) &&
        (p.nombre.toLowerCase().includes(term) || (p.club||'').toLowerCase().includes(term) || (p.pais||'').toLowerCase().includes(term))
      );

      count.textContent = items.length;
      grid.innerHTML = '';
      for(const p of items){
        const el = document.createElement('article'); el.className = 'card';
        el.innerHTML = `
          <div class="media">
            <img src="${p.img}" alt="${p.nombre}" loading="lazy" onerror="this.src='${PLACEHOLDER}'">
            <button class="fav-toggle ${favorites.has(p.id)?'active':''}" data-fav-id="${p.id}">
              ${favorites.has(p.id)?'‚ù§Ô∏è':'ü§ç'}
            </button>
          </div>
          <div class="body">
            <div class="meta">
              <div>
                <div style="font-weight:700;font-size:16px;line-height:1.2">${p.nombre}</div>
                <div class="muted">${p.club || '‚Äî'} ‚Ä¢ ${p.categoria}</div>
              </div>
              <div class="price">${uy.format(p.precio)}</div>
            </div>
            <button class="btn primary" data-id="${p.id}">Agregar al carrito</button>
          </div>`;
        grid.appendChild(el);
      }
      updateGridFavIcons();
    }

    function updateGridFavIcons(){
      document.querySelectorAll('.fav-toggle').forEach(btn=>{
        const id = Number(btn.dataset.favId);
        btn.classList.toggle('active', favorites.has(id));
        btn.textContent = favorites.has(id) ? '‚ù§Ô∏è' : 'ü§ç';
      });
    }

    grid.addEventListener('click', (e)=>{
      const addBtn = e.target.closest('button[data-id]');
      const favBtnEl = e.target.closest('.fav-toggle');

      if(addBtn){
        const id = Number(addBtn.dataset.id);
        cart.set(id, (cart.get(id) || 0) + 1);
        saveCart(); updateCartUI();
        addBtn.textContent = 'Agregado ‚úì'; setTimeout(()=> addBtn.textContent = 'Agregar al carrito', 900);
        return;
      }
      if(favBtnEl){
        const id = Number(favBtnEl.dataset.favId);
        if(favorites.has(id)) favorites.delete(id); else favorites.add(id);
        saveFavorites(); updateFavBadge(); renderFavMenu(); updateGridFavIcons(); return;
      }
    });

    // Buscador (historial + sugerencias)
    const SEARCH_HISTORY_KEY = 'lot_search_history';
    const MAX_HISTORY = 8;
    const qInput = document.getElementById('q');
    const searchMenu = document.getElementById('searchMenu');

    function loadHistory(){ try{ return JSON.parse(localStorage.getItem(SEARCH_HISTORY_KEY)) || []; }catch{ return []; } }
    function saveHistoryList(list){ localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(list.slice(0, MAX_HISTORY))); }
    function addToHistory(term){
      term = (term||'').trim(); if(term.length<2) return;
      const list = loadHistory();
      saveHistoryList([term, ...list.filter(t => t.toLowerCase() !== term.toLowerCase())]);
    }
    function clearHistory(){ localStorage.removeItem(SEARCH_HISTORY_KEY); renderSearchMenu(); }

    function getSuggestions(term){
      const t = term.trim().toLowerCase(); if(!t) return [];
      return DATA.filter(p =>
        p.nombre.toLowerCase().includes(t) || (p.club||'').toLowerCase().includes(t) || (p.pais||'').toLowerCase().includes(t)
      ).slice(0, 6);
    }

    function openSearchMenu(){ searchMenu.hidden = false; }
    function closeSearchMenu(){ searchMenu.hidden = true; activeIndex = -1; }

    function hl(text, term){
      if(!term) return text;
      const re = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'ig');
      return text.replace(re, '<span class="hl">$1</span>');
    }

    function renderSearchMenu(){
      const term = qInput.value.trim();
      const history = loadHistory();
      const suggestions = getSuggestions(term);
      let html = '';

      if(!term && history.length){
        html += `
          <div class="search-section">
            <div class="search-title">B√∫squedas recientes</div>
            <ul class="search-list">
              ${history.map(t =>
                `<li class="search-item" data-type="history" data-value="${t.replace(/"/g,'&quot;')}">
                  <span>${t}</span>
                </li>`
              ).join('')}
            </ul>
          </div>`;
      }

      if(term){
        html += `
          <div class="search-section">
            <div class="search-title">Sugerencias</div>
            ${
              suggestions.length
              ? `<ul class="search-list">
                  ${suggestions.map(p =>
                    `<li class="search-item" data-type="suggestion" data-value="${p.nombre.replace(/"/g,'&quot;')}">
                      <div>
                        <div>${hl(p.nombre, term)}</div>
                        <small>‚Ä¢ ${hl(p.club || '‚Äî', term)} ‚Äî ${hl(p.pais || '‚Äî', term)}</small>
                      </div>
                    </li>`
                  ).join('')}
                </ul>`
              : `<div class="search-empty">Sin resultados para <strong>${term}</strong></div>`
            }
          </div>`;
      }

      if(!html) html = `<div class="search-empty">Empieza a escribir para buscar</div>`;
      searchMenu.innerHTML = html;

      searchMenu.querySelectorAll('.search-item').forEach(li => {
        li.addEventListener('click', () => {
          const value = li.dataset.value;
          qInput.value = value; addToHistory(value); render(); closeSearchMenu();
        });
      });
      const clearBtn = document.getElementById('clearHistory');
      if(clearBtn) clearBtn.addEventListener('click', clearHistory);
    }

    qInput.addEventListener('focus', () => { renderSearchMenu(); openSearchMenu(); });
    qInput.addEventListener('input', () => { renderSearchMenu(); openSearchMenu(); });
    document.addEventListener('click', (e)=>{
      if(!searchMenu.hidden && !searchMenu.contains(e.target) && e.target !== qInput){ closeSearchMenu(); }
    });

    // navegaci√≥n teclado
    let activeIndex = -1;
    qInput.addEventListener('keydown', (e)=>{
      if(searchMenu.hidden) return;
      const items = Array.from(searchMenu.querySelectorAll('.search-item'));
      if(!items.length) return;

      if(e.key === 'ArrowDown'){ e.preventDefault(); activeIndex = (activeIndex + 1) % items.length; }
      else if(e.key === 'ArrowUp'){ e.preventDefault(); activeIndex = (activeIndex - 1 + items.length) % items.length; }
      else if(e.key === 'Enter' && activeIndex >= 0){ e.preventDefault(); items[activeIndex].click(); return; }
      else return;

      items.forEach(el => el.classList.remove('active'));
      items[activeIndex].classList.add('active');
      items[activeIndex].scrollIntoView({block:'nearest'});
    });

    // Header scrolled
    const siteHeader = document.getElementById('siteHeader');
    function onScroll(){ siteHeader.classList.toggle('is-scrolled', window.scrollY > 0); }
    onScroll(); window.addEventListener('scroll', onScroll, {passive:true});

    // Inputs => render
    function attachInputs(){ [price, clubSel, paisSel, catSel, q].forEach(el => el.addEventListener('input', render)); }
    attachInputs();

    // Ubicaci√≥n
    const LOCATION_KEY = 'lot_location';
    const openLocationBtn = document.getElementById('openLocation');
    const locationModal = document.getElementById('locationModal');
    const closeLocationBtn = document.getElementById('closeLocation');
    const cancelLocBtn = document.getElementById('cancelLoc');
    const deptSel = document.getElementById('departamento');
    const locSel = document.getElementById('localidad');
    const acceptLocBtn = document.getElementById('acceptLoc');
    const locText = document.getElementById('locText');

    const DEPTS = {
      "Artigas":["Artigas","Bella Uni√≥n","Tom√°s Gomensoro","Baltasar Brum"],
      "Canelones":["Canelones","Ciudad de la Costa","Las Piedras","Pando","La Paz","Progreso","Santa Luc√≠a","Atl√°ntida","Parque del Plata","Sauce","San Ram√≥n","Empalme Olmos","Toledo"],
      "Cerro Largo":["Melo","R√≠o Branco","Fraile Muerto","Tupamba√©","Isidoro Nobl√≠a"],
      "Colonia":["Colonia del Sacramento","Carmelo","Nueva Helvecia","Juan Lacaze","Rosario","Tarariras","Omb√∫es de Lavalle"],
      "Durazno":["Durazno","Sarand√≠ del Y√≠","Carmen","Centenario"],
      "Flores":["Trinidad","Ismael Cortinas"],
      "Florida":["Florida","Sarand√≠ Grande","Casup√°","25 de Mayo"],
      "Lavalleja":["Minas","Jos√© Pedro Varela","Sol√≠s de Mataojo","Mariscala"],
      "Maldonado":["Maldonado","Punta del Este","San Carlos","Piri√°polis","Pan de Az√∫car","Aigu√°","La Barra"],
      "Montevideo":["Montevideo"],
      "Paysand√∫":["Paysand√∫","Guich√≥n","Quebracho","Piedras Coloradas"],
      "R√≠o Negro":["Fray Bentos","Young","Nuevo Berl√≠n","San Javier"],
      "Rivera":["Rivera","Tranqueras","Minas de Corrales","Vichadero","Mandub√≠"],
      "Rocha":["Rocha","Chuy","Castillos","Lascano","La Paloma","Punta del Diablo"],
      "Salto":["Salto","Constituci√≥n","Bel√©n","Daym√°n","San Antonio"],
      "San Jos√©":["San Jos√© de Mayo","Ciudad del Plata","Libertad","Ecilda Paullier","Delta El Tigre","Raig√≥n"],
      "Soriano":["Mercedes","Dolores","Cardona","Jos√© Enrique Rod√≥","Palmitas"],
      "Tacuaremb√≥":["Tacuaremb√≥","Paso de los Toros","San Gregorio de Polanco","Curtina","Ansina"],
      "Treinta y Tres":["Treinta y Tres","Vergara","Santa Clara de Olimar","Villa Sara"]
    };

    function fillDept(){ Object.keys(DEPTS).forEach(d => deptSel.append(new Option(d,d))); }
    function renderLocationText(){
      const raw = localStorage.getItem(LOCATION_KEY);
      if(!raw){ locText.innerHTML = 'Ingresa tu <strong>ubicaci√≥n</strong>'; return; }
      try{ const {loc} = JSON.parse(raw); locText.textContent = `Enviar a ${loc}`; }
      catch{ locText.innerHTML = 'Ingresa tu <strong>ubicaci√≥n</strong>'; }
    }
    function openLocation(){ locationModal.classList.add('open'); showOverlay(); }
    function closeLocation(){ locationModal.classList.remove('open'); hideOverlayIfIdle(); }

    openLocationBtn.addEventListener('click', (e)=>{ e.preventDefault(); openLocation(); });
    closeLocationBtn.addEventListener('click', closeLocation);
    cancelLocBtn.addEventListener('click', closeLocation);
    overlay.addEventListener('click', ()=>{ closeCartMenu(); closeFavMenu(); closeLocation(); });

    deptSel.addEventListener('change', ()=>{
      const dept = deptSel.value;
      locSel.innerHTML = '<option value="" selected>Elija una opci√≥n</option>';
      if(!dept){ locSel.disabled = true; acceptLocBtn.disabled = true; return; }
      DEPTS[dept].forEach(loc => locSel.append(new Option(loc,loc)));
      locSel.disabled = false; acceptLocBtn.disabled = true;
    });
    locSel.addEventListener('change', ()=> acceptLocBtn.disabled = !locSel.value);
    document.getElementById('locForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!deptSel.value || !locSel.value) return;
      localStorage.setItem(LOCATION_KEY, JSON.stringify({dept:deptSel.value, loc:locSel.value}));
      renderLocationText(); closeLocation();
    });

    fillDept(); renderLocationText();

    // HERO: fondos rotativos + flechas
    (function(){
      const hero = document.querySelector('.hero');
      const fondos = [
        './assets/fondo1.png',
        './assets/fondo2.png',
        './assets/fondo3.png',
        './assets/fondo4.png'
      ];
      let idx = 0;
      const prevBtn = document.querySelector('.hero-nav.prev');
      const nextBtn = document.querySelector('.hero-nav.next');

      function setBg(){ hero.style.backgroundImage = `url('${fondos[idx]}')`; }
      function next(){ idx = (idx+1) % fondos.length; setBg(); }
      function prev(){ idx = (idx-1+fondos.length) % fondos.length; setBg(); }

      setBg();
      const INTERVAL = 7000;
      let timer = setInterval(next, INTERVAL);
      function restart(){ clearInterval(timer); timer = setInterval(next, INTERVAL); }
      nextBtn.addEventListener('click', ()=>{ next(); restart(); });
      prevBtn.addEventListener('click', ()=>{ prev(); restart(); });
      hero.addEventListener('mouseenter', ()=> clearInterval(timer));
      hero.addEventListener('mouseleave', restart);
    })();

    // Mensaje rotativo del header
    const messages = [
      "Env√≠os seguros y r√°pidos",
      "Llev√° la historia en tu camiseta",
      "Tu pedido llega directo a tu puerta",
      "Pag√° con total confianza"
    ];
    let msgIndex = 0;
    setInterval(()=>{
      msgIndex = (msgIndex + 1) % messages.length;
      document.getElementById('headerMessage').textContent = messages[msgIndex];
    }, 3000);

    // Submen√∫ categor√≠as
    const catsDrop = document.getElementById('catsDrop');
    const catsLink = document.getElementById('catsLink');
    const catsMenu = document.getElementById('catsMenu');

    catsMenu.addEventListener('click', (e)=>{
      const a = e.target.closest('a[data-cat]'); if(!a) return;
      e.preventDefault();
      catSel.value = a.dataset.cat;
      render();
      document.getElementById('catalogo').scrollIntoView({behavior:'smooth', block:'start'});
      catsDrop.classList.remove('open');
      catsLink.setAttribute('aria-expanded','false');
    });

    catsLink.addEventListener('click', (e)=>{
      if (window.matchMedia('(max-width: 820px)').matches){
        e.preventDefault();
        const isOpen = catsDrop.classList.toggle('open');
        catsLink.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      }
    });

    document.addEventListener('click', (e)=>{
      if(!catsDrop.contains(e.target)){
        catsDrop.classList.remove('open');
        catsLink.setAttribute('aria-expanded','false');
      }
    });

    // ===== INICIALIZAR =====
    updateFavBadge();
    updateCartBadge();
    updateCartUI();
    renderFavMenu();
    updateNotBadge();
    renderNotifications();
  </script>

  <!-- ===== SUPABASE: widget de usuario y cargar publicaciones ===== -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = 'https://imexctmcesopdfdebsgo.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZXhjdG1jZXNvcGRmZGVic2dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDczMDIsImV4cCI6MjA3NDg4MzMwMn0.g1lziVKAuUvMEOkYxJhe2D2z8PlwGJ6xcXo_SSpTj7Q'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    
    const loginBtn   = document.getElementById('loginBtn')
    const userWidget = document.getElementById('userWidget')
    const avatarEl   = document.getElementById('userAvatar')
    const greetEl    = document.getElementById('greeting')
    const userMenu   = document.getElementById('userMenu')
    const logoutBtn  = document.getElementById('logoutBtn')
  
    const initialsFrom = (nombre='', apellido='', email='')=>{
      const n = (nombre||'').trim().split(/\s+/)[0] || ''
      const a = (apellido||'').trim().split(/\s+/)[0] || ''
      const ini = (n[0]||'') + (a[0]||'')
      return (ini || (email[0]||'?')).toUpperCase()
    }
    const firstNameFrom = (nombre='', email='')=>{
      const n = (nombre||'').trim().split(/\s+/)[0]
      return n || (email || '').split('@')[0]
    }
  
    // ===== CARGAR PUBLICACIONES DESDE SUPABASE =====
    async function cargarPublicaciones() {
      try {
        console.log('üîç Cargando publicaciones desde Supabase...');
        
        // Cargar publicaciones con sus fotos
        const { data: publicaciones, error } = await supabase
          .from('publicacion')
          .select(`
            *,
            foto (*)
          `)
          .eq('estado', 'Activa');
  
        if (error) {
          console.error('‚ùå Error cargando publicaciones:', error);
          return;
        }
  
        console.log('‚úÖ Publicaciones cargadas con fotos:', publicaciones);
        procesarPublicaciones(publicaciones);
        
      } catch (error) {
        console.error('üí• Error al cargar publicaciones:', error);
      }
    }
  
    function procesarPublicaciones(publicaciones) {
      // Transformar los datos al formato que espera tu frontend
      DATA = publicaciones.map(pub => {
        // Obtener la primera foto (si existe)
        const primeraFoto = pub.foto && pub.foto.length > 0 ? pub.foto[0].url : null;
        
        return {
          id: pub.id_publicacion,
          nombre: pub.titulo,
          precio: pub.precio,
          club: pub.club,
          pais: 'Uruguay', // Temporal
          categoria: formatCategoria(pub.categoria),
          img: primeraFoto || PLACEHOLDER, // Usar la foto real o el placeholder
          talle: pub.talle,
          condicion: pub.condicion,
          autenticidad: pub.autenticidad,
          stock: pub.stock,
          descripcion: pub.descripcion,
          sellerId: pub.id_usuario,
          // Guardar todas las fotos por si las necesitas despu√©s
          fotos: pub.foto || []
        }
      });
      
      console.log('üîÑ DATA transformada con im√°genes:', DATA);
      
      // Llenar los filtros de club y pa√≠s
      llenarFiltros();
      
      // Renderizar el cat√°logo
      render();
    }
  
    function formatCategoria(cat) {
      if (!cat) return 'Club';
      if (cat === 'Seleccion') return 'Selecci√≥n';
      return cat;
    }
  
    // Funci√≥n para llenar los select de filtros
    function llenarFiltros() {
      const clubs = [...new Set(DATA.map(p => p.club).filter(Boolean))];
      const paises = [...new Set(DATA.map(p => p.pais).filter(Boolean))];
      
      // Limpiar selects
      const clubSel = document.getElementById('club');
      const paisSel = document.getElementById('pais');
      
      clubSel.innerHTML = '<option value="">Todos los clubes</option>';
      paisSel.innerHTML = '<option value="">Todos los pa√≠ses</option>';
      
      // Llenar clubes
      clubs.forEach(club => {
        clubSel.appendChild(new Option(club, club));
      });
      
      // Llenar pa√≠ses
      paises.forEach(pais => {
        paisSel.appendChild(new Option(pais, pais));
      });
    }
  
    async function refreshHeader(){
      const { data: { session } } = await supabase.auth.getSession()
      if (!session){
        userWidget.classList.add('hidden')
        loginBtn.classList.remove('hidden')
        return
      }
      const uid = session.user.id
      let nombre = '', apellido = '', email = session.user.email || ''
      
      try{
        const { data: perfil, error } = await supabase
          .from('usuario')
          .select('nombre, apellido, email')
          .eq('id_auth', uid)
          .maybeSingle()
          
        if (error) {
          console.log('‚ö†Ô∏è Error cargando perfil:', error);
          nombre = session.user.user_metadata?.nombre || ''
          apellido = session.user.user_metadata?.apellido || ''
        } else if (perfil) {
          nombre = perfil.nombre || session.user.user_metadata?.nombre || ''
          apellido = perfil.apellido || session.user.user_metadata?.apellido || ''
          email = perfil.email || email
        } else {
          nombre = session.user.user_metadata?.nombre || ''
          apellido = session.user.user_metadata?.apellido || ''
        }
      } catch(error) {
        console.error('Error cargando perfil:', error);
        nombre = session.user.user_metadata?.nombre || ''
        apellido = session.user.user_metadata?.apellido || ''
      }
  
      avatarEl.textContent = initialsFrom(nombre, apellido, email)
      greetEl.textContent  = `Hola, ${firstNameFrom(nombre, email)}!`
  
      loginBtn.classList.add('hidden')
      userWidget.classList.remove('hidden')
    }
  
    // Inicializar la aplicaci√≥n
    await refreshHeader();
    
    // CARGAR LAS PUBLICACIONES DESDE SUPABASE
    await cargarPublicaciones();
  
    supabase.auth.onAuthStateChange(() => { 
      refreshHeader(); 
    })
  
    // Toggle men√∫ usuario
    userWidget.addEventListener('click', (e)=>{
      if(e.target.closest('#userMenu')) return
      userMenu.classList.toggle('hidden')
    })
    document.addEventListener('click', (e)=>{
      if(!userWidget.contains(e.target)) userMenu.classList.add('hidden')
    })
  
    // Logout
    logoutBtn.addEventListener('click', async (e)=>{
      e.preventDefault()
      await supabase.auth.signOut()
      location.reload()
    })
  
    // MODAL PRODUCTO - ACTUALIZADO PARA MOSTRAR M√öLTIPLES FOTOS
    const SELLERS = {
      1: { nombre:'Ignacio Iglesia', email:'iaioiglesia@icloud.com' },
      2: { nombre:'Mar√≠a P√©rez', email:'maria@example.com' }
    };
    const productModal = document.getElementById('productModal');
    const closeProduct = document.getElementById('closeProduct');
    const pdImage = document.getElementById('pdImage');
    const pdTitle = document.getElementById('pdTitle');
    const pdPrice = document.getElementById('pdPrice');
    const pdCategoria = document.getElementById('pdCategoria');
    const pdTalle = document.getElementById('pdTalle');
    const pdCondicion = document.getElementById('pdCondicion');
    const pdAuth = document.getElementById('pdAuth');
    const pdStock = document.getElementById('pdStock');
    const pdDesc = document.getElementById('pdDesc');
    const pdSeller = document.getElementById('pdSeller');
    const pdSellerEmail = document.getElementById('pdSellerEmail');
    const pdAvatar = document.getElementById('pdAvatar');
    const pdAddCart = document.getElementById('pdAddCart');
  
    function initialsFromFull(full=''){
      const [a='',b=''] = full.trim().split(/\s+/);
      return (a[0]||'?') + (b[0]||'');
    }
  
    function openProductModal(item){
      // Usar la imagen real en lugar del placeholder
      pdImage.src = item.img;
      pdImage.onerror = ()=>{ pdImage.src = PLACEHOLDER; }
      pdTitle.textContent = item.nombre || 'Publicaci√≥n';
      pdPrice.textContent = new Intl.NumberFormat('es-UY',{style:'currency',currency:'UYU',maximumFractionDigits:0}).format(item.precio || 0);
      pdCategoria.textContent = item.categoria || '-';
      pdTalle.textContent = item.talle || '‚Äî';
      pdCondicion.textContent = item.condicion || '‚Äî';
      pdAuth.textContent = item.autenticidad || '‚Äî';
      pdStock.textContent = (item.stock ?? '‚Äî');
      pdDesc.textContent = item.descripcion || '‚Äî';
  
      let sellerName = 'Usuario';
      let sellerEmail = '';
      if (item.sellerId && SELLERS[item.sellerId]){
        sellerName = SELLERS[item.sellerId].nombre;
        sellerEmail = SELLERS[item.sellerId].email || '';
      }
      pdSeller.textContent = sellerName;
      pdSellerEmail.textContent = sellerEmail;
      pdAvatar.textContent = initialsFromFull(sellerName).toUpperCase();
  
      pdAddCart.onclick = ()=>{
        cart.set(item.id, (cart.get(item.id) || 0) + 1);
        saveCart();
        updateCartUI();
        productModal.classList.remove('open');
        document.getElementById('cartMenu').classList.add('open');
        document.getElementById('overlay').classList.add('show');
      };
  
      productModal.classList.add('open');
      document.getElementById('overlay').classList.add('show');
    }
  
    closeProduct.addEventListener('click', ()=>{
      productModal.classList.remove('open');
      document.getElementById('overlay').classList.remove('show');
    });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ productModal.classList.remove('open'); document.getElementById('overlay').classList.remove('show'); }});
    document.getElementById('overlay')?.addEventListener('click', ()=>{
      productModal.classList.remove('open');
      document.getElementById('overlay').classList.remove('show');
    });
  
    // Abrir modal al clickear card (excepto botones)
    const gridEl = document.getElementById('grid');
    gridEl.addEventListener('click', (e)=>{
      const btnAdd = e.target.closest('button[data-id]');
      const fav = e.target.closest('.fav-toggle');
      if (btnAdd || fav) return;
      const card = e.target.closest('.card');
      if(!card) return;
      const idAttrBtn = card.querySelector('button[data-id]');
      const id = idAttrBtn ? Number(idAttrBtn.dataset.id) : null;
      if(!id) return;
      const item = DATA.find(p => p.id === id);
      if(!item) return;
      openProductModal(item);
    });
  </script>
</body>
</html>