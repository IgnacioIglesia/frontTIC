<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ofertas ‚Äî La Otra Tribuna</title>
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="stylesheet" href="styles/mobile.css" />
  <script src="scripts/mobile-nav.js" defer></script>
  <link rel="stylesheet" href="styles/user-widget.css" />
  <link rel="stylesheet" href="styles/notifications.css" />
  <link rel="icon" type="image/png" href="./assets/logo.png" />
  <style>
    /* Para que la barra llegue completa al m√°ximo */
    #price.range{ width:100%; background:linear-gradient(to right,#064e3b 100%,#e5e7eb 0%) }
    #price.range::-webkit-slider-runnable-track{ background:linear-gradient(to right,#064e3b var(--percent,100%),#e5e7eb var(--percent,100%)) }
    #price.range::-moz-range-track{ background:linear-gradient(to right,#064e3b var(--percent,100%),#e5e7eb var(--percent,100%)) }

    /* ===== Hero Ofertas ===== */
    .hero-ofertas{
      background:url('./assets/oferta3.png') center/cover no-repeat;
      min-height:280px; display:flex; flex-direction:column; align-items:center; justify-content:flex-end;
      text-align:center; color:#fff; padding-bottom:20px;
    }
    .hero-ofertas .copy h1{ margin:0; font-weight:800; font-size:clamp(24px,4vw,40px) }
    .hero-ofertas .hero-sub{ margin-top:6px; opacity:.95; font-size:clamp(14px,2.2vw,18px) }
  </style>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header id="siteHeader">
    <div class="top container">
      <div class="brand-wrap">
        <a href="index.html" class="logo-link" aria-label="Ir al inicio">
          <img class="logo" src="./assets/logo.png" alt="La Otra Tribuna" />
        </a>
      </div>

      <div class="search">
        <input id="q" type="search" placeholder="Buscar club o pa√≠s‚Ä¶" autocomplete="off" />
      </div>

      <div class="header-messages" id="headerMessage">Aprovech√° las mejores ofertas</div>

      <div class="actions" style="display:flex;align-items:center;gap:12px;">
        <!-- Bot√≥n por defecto (si NO hay sesi√≥n) -->
        <a id="loginBtn" href="login.html" class="btn-login">Iniciar sesi√≥n</a>

        <!-- Widget de usuario (oculto hasta que haya sesi√≥n) -->
        <div id="userWidget" class="user-widget hidden" aria-live="polite" style="position:relative;">
          <div id="userAvatar" class="user-avatar" title="Mi perfil"></div>
          <span id="greeting" class="user-greeting"></span>
          <div id="userMenu" class="user-menu hidden">
            <a href="perfil.html">üë§ Perfil</a>
            <a href="mis_publicaciones.html">üìä Mis Publicaciones</a>
            <a href="mis-pedidos.html">üßæ Mis pedidos</a>
            <a href="#" id="logoutBtn" class="menu-divider">üö™ Cerrar sesi√≥n</a>
          </div>
        </div>

        <!-- Tus botones existentes -->
        <button class="pill" id="favBtn" aria-label="Abrir favoritos">‚ù§Ô∏è<span id="favCount">0</span></button>
        <button class="pill" id="cartBtn" aria-label="Abrir carrito">üõí <span id="cartCount">0</span></button>
      </div>
    </div>
    <button class="burger" aria-expanded="false" aria-controls="mnav" aria-label="Abrir men√∫">
      <span>‚â°</span>
    </button>


    <!-- ===== SUBNAV ===== -->
    <nav class="subnav">
      <div class="container subnav-inner">
        <div class="subnav-left">
          <a href="#ubicacion" class="loc-link" id="openLocation">
            <svg class="loc-ic" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22s7-6.46 7-12a7 7 0 1 0-14 0c0 5.54 7 12 7 12Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <span class="loc-line" id="locText">Enviar a <strong>Montevideo</strong></span>
          </a>
        </div>

        <div class="subnav-center">
          <div class="has-submenu" id="catsDrop">
            <a href="index.html" class="subnav-link" id="catsLink" aria-haspopup="true" aria-expanded="false">
              Categor√≠as <span class="chev" aria-hidden="true">‚ñæ</span>
            </a>
            <div class="cat-submenu" id="catsMenu" role="menu" aria-label="Categor√≠as">
              <a href="index.html?cat=club#catalogo">Club</a>
              <a href="index.html?cat=seleccion#catalogo">Selecci√≥n</a>
              <a href="index.html?cat=retro#catalogo">Retro</a>
            </div>
          </div>
          <a href="ofertas.html" class="subnav-link">Ofertas</a>
          <a href="vender.html" class="subnav-link">Vender</a>
          <a href="rastrear.html" class="subnav-link">Rastrear Pedido</a>
        </div>

        <div class="subnav-right">
          <a href="favoritos.html" class="subnav-link" id="favLink">Favoritos</a>
          <a href="como-funciona.html" class="subnav-link">C√≥mo funciona</a>
          <a href="autenticidad.html" class="subnav-link">Autenticidad</a>
          <a href="ayuda.html" class="subnav-link">Ayuda</a>
        </div>
      </div>
    </nav>

    <nav id="mnav" class="mnav" role="dialog" aria-modal="true" aria-label="Men√∫">
      <div class="mnav-head">
        <strong>Men√∫</strong>
        <button type="button" class="close-mnav" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="mnav-search">
        <input id="mq" type="search" placeholder="Buscar camisetas‚Ä¶" autocomplete="off" />
        <div id="msearchMenu" class="search-menu" hidden></div>
      </div>
      <div class="mnav-links">
        <a href="index.html">Inicio</a>
        <a href="ofertas.html">Ofertas</a>
        <a href="vender.html">Vender</a>
        <a href="rastrear.html">Rastrear Pedido</a>
        <a href="favoritos.html">Favoritos</a>
        <a href="como-funciona.html">C√≥mo funciona</a>
        <a href="autenticidad.html">Autenticidad</a>
        <a href="ayuda.html">Ayuda</a>
      </div>
    </nav>
  </header>

  <!-- ===== HERO OFERTAS ===== -->
  <section class="hero hero-ofertas">
    <div class="copy">
      <h1>Los mejores descuentos</h1>
      <p class="hero-sub">Aprovech√° nuestras promos por tiempo limitado.</p>
    </div>
  </section>

  <!-- ===== OVERLAY UBICACI√ìN ===== -->
  <div id="overlay" class="overlay"></div>
  <div id="locationModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Elige d√≥nde recibir tus compras</h3>
        <button class="modal-close" id="closeLocation" aria-label="Cerrar">‚úï</button>
      </div>
      <form id="locForm" class="loc-form" autocomplete="off">
        <div class="field">
          <label for="departamento">Departamento</label>
          <select id="departamento" required>
            <option value="" selected>Elija una opci√≥n</option>
          </select>
        </div>
        <div class="field">
          <label for="localidad">Localidad</label>
          <select id="localidad" required disabled>
            <option value="" selected>Elija una opci√≥n</option>
          </select>
        </div>
        <div class="actions-row">
          <button type="button" class="btn" id="cancelLoc">Cancelar</button>
          <button type="submit" class="btn primary" id="acceptLoc" disabled>Aceptar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== PANELES LATERALES ===== -->
  <aside id="cartMenu" class="cart-menu">
    <div class="cart-header">
      <h3>Tu carrito</h3>
      <button id="closeCart" class="close-btn">‚úï</button>
    </div>
    <div id="cartItems" class="cart-items">
      <p class="muted">Tu carrito est√° vac√≠o</p>
    </div>
    <div class="cart-footer">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span>Total:</span>
        <strong id="cartTotal">$ 0</strong>
      </div>
      <button class="btn primary checkout-btn">Finalizar compra</button>
    </div>
  </aside>

  <aside id="favMenu" class="cart-menu">
    <div class="cart-header">
      <h3>Favoritos</h3>
      <button id="closeFav" class="close-btn">‚úï</button>
    </div>
    <div id="favItems" class="cart-items">
      <p class="muted">A√∫n no agregaste favoritos</p>
    </div>
    <div class="cart-footer">
      <button class="btn primary checkout-btn" id="favGoCart">Pasar todo al carrito</button>
    </div>
  </aside>

  <!-- ===== CONTENIDO ===== -->
  <main>
    <div class="container">
      <section id="catalogo" style="padding-top:20px">
        <h2>Ofertas</h2>
        <p class="muted">Resultados: <span id="count">0</span></p>
        <div id="grid" class="grid"></div>
      </section>

      <footer>¬©Ô∏è <span id="year"></span> La Otra Tribuna.</footer>
    </div>
  </main>

  <script src="scripts/uy-depts.js"></script>
  <script>
    // ===== ELEMENTOS DEL DOM =====
    const grid = document.getElementById('grid');
    const count = document.getElementById('count');
    const overlay = document.getElementById('overlay');
    
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== VARIABLES GLOBALES =====
    const PLACEHOLDER = 'https://placehold.co/600x750?text=Camiseta';
    const uy = new Intl.NumberFormat('es-UY',{style:'currency',currency:'UYU',maximumFractionDigits:0});
    let DATA = []; // Ahora se cargar√° desde Supabase

    // ===== FAVORITOS PERSISTENTES =====
    let favorites = new Set();
    function initializeFavorites() {
        const saved = localStorage.getItem('lot_favorites');
        favorites = new Set(saved ? JSON.parse(saved) : []);
        console.log('Favoritos inicializados:', favorites.size);
    }
    function saveFavorites(){ localStorage.setItem('lot_favorites', JSON.stringify([...favorites])); }

    // ===== CARRITO PERSISTENTE =====
    const cart = new Map(Object.entries(JSON.parse(localStorage.getItem('lot_cart') || '{}')).map(([k,v]) => [+k, v]));
    function saveCart(){ localStorage.setItem('lot_cart', JSON.stringify(Object.fromEntries(cart))); }

    // ===== RENDERIZAR MEN√ö DE FAVORITOS =====
    function renderFavMenu() {
      const favItemsDiv = document.getElementById('favItems');
      if (!favItemsDiv) return;
      
      favItemsDiv.innerHTML = '';
      
      if (favorites.size === 0) {
        favItemsDiv.innerHTML = '<p class="muted">A√∫n no agregaste favoritos</p>';
        return;
      }
      
      favorites.forEach(id => {
        const prod = DATA.find(p => p.id === id);
        if (!prod) return;
        
        // Usar precio_oferta si existe, sino precio normal
        const precioFinal = prod.precio_oferta || prod.precio;
        
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <img src="${prod.img}" alt="${prod.nombre}" onerror="this.src='${PLACEHOLDER}'">
          <div class="meta">
            <strong>${prod.nombre}</strong>
            <span class="muted">${uy.format(precioFinal)}${prod.precio_oferta ? ' <span style="color:#d92d20;font-size:12px">(10% OFF)</span>' : ''}</span>
            <div class="qty">
              <button class="icon" data-act="addcart" data-id="${id}" title="Agregar al carrito">üõí</button>
              <button class="icon" data-act="rmfav" data-id="${id}" title="Quitar de favoritos">üóë</button>
            </div>
          </div>`;
        favItemsDiv.appendChild(row);
      });
    }

    // ===== PANEL CARRITO =====
    const cartBtn = document.getElementById('cartBtn');
    const closeCart = document.getElementById('closeCart');
    const cartItemsDiv = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    const cartMenu = document.getElementById('cartMenu');

    function showOverlay(){ overlay.classList.add('show'); }
    function hideOverlay(){ overlay.classList.remove('show'); }
    function hideOverlayIfIdle(){
      const cartOpen = document.querySelector('.cart-menu.open');
      const favOpen = document.querySelector('#favMenu.open');
      const locOpen = document.getElementById('locationModal').classList.contains('open');
      
      if (!cartOpen && !favOpen && !locOpen) {
        hideOverlay();
      }
    }
    function openCart(){ 
      cartMenu.classList.add('open'); 
      showOverlay(); 
      updateCartUI(); 
    }
    function closeCartMenu(){ 
      cartMenu.classList.remove('open'); 
      hideOverlayIfIdle(); 
    }

    // ===== PANEL FAVORITOS =====
    const favBtn = document.getElementById('favBtn');
    const favMenu = document.getElementById('favMenu');
    const closeFav = document.getElementById('closeFav');
    const favItemsDiv = document.getElementById('favItems');
    const favGoCartBtn = document.getElementById('favGoCart');

    function openFav(){ 
      favMenu.classList.add('open'); 
      showOverlay(); 
      renderFavMenu();
    }
    function closeFavMenu(){ 
      favMenu.classList.remove('open'); 
      hideOverlayIfIdle(); 
    }

    // ===== CERRAR PANELES AL HACER CLIC EN OVERLAY =====
    overlay.addEventListener('click', () => {
      closeCartMenu();
      closeFavMenu();
      closeLocation();
    });

    // Tambi√©n agregar para cerrar con tecla Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeCartMenu();
        closeFavMenu();
        closeLocation();
      }
    });

    // Event listeners para botones
    cartBtn.addEventListener('click', openCart);
    closeCart.addEventListener('click', closeCartMenu);

    favBtn.addEventListener('click', openFav);
    closeFav.addEventListener('click', closeFavMenu);

    function updateCartUI(){
      let totalPrice = 0;
      cartItemsDiv.innerHTML = '';
      if (cart.size === 0) {
        cartItemsDiv.innerHTML = '<p class="muted">Tu carrito est√° vac√≠o</p>';
        cartTotal.textContent = '$ 0'; 
        updateCartBadge(); 
        return;
      }
      
      cart.forEach((qty, id) => {
        const prod = DATA.find(p => p.id === id);
        if (prod) {
          // Usar precio_oferta si existe, sino precio normal
          const precioFinal = prod.precio_oferta || prod.precio;
          const itemTotal = precioFinal * qty; 
          totalPrice += itemTotal;
          
          const row = document.createElement('div');
          row.className = 'cart-item';
          row.innerHTML = `
            <img src="${prod.img}" alt="${prod.nombre}" onerror="this.src='${PLACEHOLDER}'">
            <div class="meta">
              <strong>${prod.nombre}</strong>
              <span class="muted">${uy.format(precioFinal)} c/u${prod.precio_oferta ? ' <span style="color:#d92d20;font-size:12px">(10% OFF)</span>' : ''}</span>
              <div class="qty">
                <button class="icon" data-act="dec" data-id="${id}">‚àí</button>
                <span>${qty}</span>
                <button class="icon" data-act="inc" data-id="${id}">Ôºã</button>
                <button class="icon" data-act="rm" data-id="${id}" title="Quitar">üóë</button>
              </div>
            </div>
            <div><strong>${uy.format(itemTotal)}</strong></div>`;
          cartItemsDiv.appendChild(row);
        }
      });
      cartTotal.textContent = uy.format(totalPrice); 
      updateCartBadge();
    }

    cartItemsDiv.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.icon'); 
      if (!btn) return;
      const id = Number(btn.dataset.id); 
      const act = btn.dataset.act;
      if (act === 'inc') cart.set(id, (cart.get(id) || 0) + 1);
      else if (act === 'dec') { 
        const current = cart.get(id) || 0; 
        if (current > 1) cart.set(id, current - 1); 
        else cart.delete(id);
      }
      else if (act === 'rm') cart.delete(id);
      saveCart(); 
      updateCartUI();
    });

    favGoCartBtn.addEventListener('click', ()=>{
      favorites.forEach(id=>{ 
        const prod = DATA.find(p=>p.id===id); 
        if(!prod) return; 
        cart.set(id, (cart.get(id) || 0) + 1);
      });
      saveCart(); 
      updateCartUI(); 
      openCart();
    });

    favItemsDiv.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.icon'); 
      if(!btn) return;
      const id = Number(btn.dataset.id), act = btn.dataset.act;
      const prod = DATA.find(p => p.id === id); 
      if(!prod) return;
      
      if(act==='addcart'){ 
        cart.set(id, (cart.get(id) || 0) + 1);
        saveCart(); 
        updateCartUI(); 
        openCart(); 
      }
      else if(act==='rmfav'){ 
        favorites.delete(id); 
        saveFavorites(); 
        updateFavBadge(); 
        renderFavMenu();
        updateGridFavIcons(); 
      }
    });

    // ===== BADGES =====
    function updateFavBadge(){
      const favCountBadge = document.getElementById('favCount');
      if (favCountBadge) favCountBadge.textContent = favorites.size;
    }
    function updateCartBadge(){
      const cartCountBadge = document.getElementById('cartCount');
      if (cartCountBadge) {
        let totalQty = 0; 
        cart.forEach(qty => totalQty += qty);
        cartCountBadge.textContent = totalQty;
      }
    }

    // ===== Render grilla con datos reales =====
    function render(){
      console.log('Renderizando DATA:', DATA);
      count.textContent = DATA.length;
      grid.innerHTML = '';

      for(const p of DATA){
        const precioConDescuento = p.precio_oferta || p.precio;
        const el = document.createElement('article');
        el.className = 'card';
        el.innerHTML = `
          <div class="media">
            <img src="${p.img}" alt="${p.nombre}" loading="lazy" onerror="this.src='${PLACEHOLDER}'">
            <span class="badge" style="position:absolute;left:8px;top:8px;background:#d92d20;color:#fff;border-radius:999px;padding:4px 8px;font-size:12px">-10%</span>
            <button class="fav-toggle ${favorites.has(p.id)?'active':''}" data-fav-id="${p.id}" title="Agregar a favoritos">
              ${favorites.has(p.id)?'‚ù§Ô∏è':'ü§ç'}
            </button>
          </div>
          <div class="body">
            <div class="meta">
              <div>
                <div style="font-weight:700;font-size:16px;line-height:1.2">${p.nombre}</div>
                <div class="muted">${p.club} ‚Ä¢ ${p.categoria}</div>
              </div>
              <div class="price">
                <div style="font-weight:700">${uy.format(precioConDescuento)}</div>
                <div class="muted" style="text-decoration:line-through;font-size:12px">${uy.format(p.precio)}</div>
              </div>
            </div>
            <button class="btn primary" data-id="${p.id}">Agregar al carrito</button>
          </div>`;
        grid.appendChild(el);
      }
      updateGridFavIcons();
    }

    function updateGridFavIcons(){
      document.querySelectorAll('.fav-toggle').forEach(btn=>{
        const id = Number(btn.dataset.favId);
        btn.classList.toggle('active', favorites.has(id));
        btn.textContent = favorites.has(id) ? '‚ù§Ô∏è' : 'ü§ç';
      });
    }

    grid.addEventListener('click', (e)=>{
  // Primero verificar si se hizo clic en la tarjeta (no en botones)
  const card = e.target.closest('.card');
  if (card && !e.target.closest('button')) {
    const idAttrBtn = card.querySelector('button[data-id]');
    const id = idAttrBtn ? Number(idAttrBtn.dataset.id) : null;
    if (id) {
      // Redirigir a la p√°gina de publicaci√≥n
      window.location.href = `publicacion.html?id=${id}`;
      return;
    }
  }
  
  // Luego verificar botones espec√≠ficos
  const addBtn = e.target.closest('button[data-id]');
  const favBtn = e.target.closest('.fav-toggle');

  if(addBtn){
    const id = Number(addBtn.dataset.id);
    cart.set(id, (cart.get(id) || 0) + 1);
    saveCart(); 
    updateCartUI();
    addBtn.textContent = 'Agregado ‚úì'; 
    setTimeout(()=> addBtn.textContent = 'Agregar al carrito', 900);
    return;
  }
  if(favBtn){
    const id = Number(favBtn.dataset.favId);
    if(favorites.has(id)) favorites.delete(id); 
    else favorites.add(id);
    saveFavorites(); 
    updateFavBadge(); 
    renderFavMenu(); 
    updateGridFavIcons(); 
    return;
  }
});

    // ===== Ubicaci√≥n =====
    const LOCATION_KEY = 'lot_location';
    const locationModal = document.getElementById('locationModal');
    const openLocationBtn = document.getElementById('openLocation');
    const closeLocationBtn = document.getElementById('closeLocation');
    const cancelLocBtn = document.getElementById('cancelLoc');
    const deptSel = document.getElementById('departamento');
    const locSel = document.getElementById('localidad');
    const acceptLocBtn = document.getElementById('acceptLoc');
    const locText = document.getElementById('locText');

    // Usar DEPTS del archivo externo uy-depts.js
    const DEPTS = window.UY_DEPTS || {"Montevideo":["Montevideo"]};

    function fillDept(){ Object.keys(DEPTS).forEach(d => deptSel.append(new Option(d,d))); }
    function renderLocationText(){
      const raw = localStorage.getItem(LOCATION_KEY);
      if(!raw){ locText.innerHTML = 'Ingresa tu <strong>ubicaci√≥n</strong>'; return; }
      try{ const {loc} = JSON.parse(raw); locText.textContent = `Enviar a ${loc}`; }
      catch{ locText.innerHTML = 'Ingresa tu <strong>ubicaci√≥n</strong>'; }
    }
    function openLocation(){ locationModal.classList.add('open'); showOverlay(); }
    function closeLocation(){ locationModal.classList.remove('open'); hideOverlayIfIdle(); }

    openLocationBtn.addEventListener('click', (e)=>{ e.preventDefault(); openLocation(); });
    closeLocationBtn.addEventListener('click', closeLocation);
    cancelLocBtn.addEventListener('click', closeLocation);

    deptSel.addEventListener('change', ()=>{
      const dept = deptSel.value;
      locSel.innerHTML = '<option value="" selected>Elija una opci√≥n</option>';
      if(!dept){ locSel.disabled = true; acceptLocBtn.disabled = true; return; }
      (DEPTS[dept] || []).forEach(l => locSel.append(new Option(l,l)));
      locSel.disabled = false; acceptLocBtn.disabled = true;
    });
    locSel.addEventListener('change', ()=> acceptLocBtn.disabled = !locSel.value);
    document.getElementById('locForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!deptSel.value || !locSel.value) return;
      localStorage.setItem(LOCATION_KEY, JSON.stringify({dept:deptSel.value, loc:locSel.value}));
      renderLocationText(); closeLocation();
    });

    fillDept(); 
    renderLocationText();

    // ===== INICIALIZAR =====
    function inicializarUI() {
      console.log('Inicializando UI con DATA:', DATA.length);
      updateFavBadge();
      updateCartBadge();
      updateCartUI();
      renderFavMenu();
      updateGridFavIcons();
      render(); // Asegurar que se renderice
    }

    // Hacer funciones globales para que el m√≥dulo Supabase pueda llamarlas
    window.inicializarUI = inicializarUI;
    window.updateGridFavIcons = updateGridFavIcons;
    window.render = render;
    window.initializeFavorites = initializeFavorites; // ‚Üê ESTA ES LA QUE FALTABA
  </script>

  <!-- ===== NOTIFICACIONES: SOLO EL JS (sin HTML adicional) ===== -->
  <script type="module" src="scripts/notifications.js"></script>

  <!-- ===== SUPABASE: cargar publicaciones en ofertas ===== -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = 'https://imexctmcesopdfdebsgo.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZXhjdG1jZXNvcGRmZGVic2dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDczMDIsImV4cCI6MjA3NDg4MzMwMn0.g1lziVKAuUvMEOkYxJhe2D2z8PlwGJ6xcXo_SSpTj7Q' 

    const supabase  = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    const loginBtn  = document.getElementById('loginBtn')
    const userWdg   = document.getElementById('userWidget')
    const avatarEl  = document.getElementById('userAvatar')
    const greetEl   = document.getElementById('greeting')
    const userMenu  = document.getElementById('userMenu')
    const logoutBtn = document.getElementById('logoutBtn')

    const initialsFrom = (n='',a='',e='')=>{
      const ini = (n.trim().split(/\s+/)[0]?.[0]||'') + (a.trim().split(/\s+/)[0]?.[0]||'')
      return (ini || (e?.[0]||'?')).toUpperCase()
    }
    const firstNameFrom = (n='',e='')=>{
      const f = n.trim().split(/\s+/)[0]
      return f || (e||'').split('@')[0]
    }

    async function refreshHeader(){
      const { data:{ session } } = await supabase.auth.getSession()
      if(!session){
        userWdg.classList.add('hidden')
        loginBtn.classList.remove('hidden')
        return
      }
      const uid = session.user.id
      let nombre='', apellido='', email=session.user.email||''
      try{
        const { data: perfil } = await supabase
          .from('usuario')
          .select('nombre, apellido, email')
          .eq('id_auth', uid)
          .maybeSingle()
        if(perfil){
          nombre  = perfil.nombre   || session.user.user_metadata?.nombre   || ''
          apellido= perfil.apellido || session.user.user_metadata?.apellido || ''
          email   = perfil.email    || email
        }else{
          nombre   = session.user.user_metadata?.nombre   || ''
          apellido = session.user.user_metadata?.apellido || ''
        }
      }catch(_){}

      avatarEl.textContent = initialsFrom(nombre, apellido, email)
      greetEl.textContent  = `Hola, ${firstNameFrom(nombre, email)}!`
      loginBtn.classList.add('hidden')
      userWdg.classList.remove('hidden')
    }

    // ===== CARGAR PUBLICACIONES EN OFERTAS =====
    async function cargarPublicacionesOfertas() {
      try {
        // Calcular fecha l√≠mite (hace 30 d√≠as)
        const fechaLimite = new Date();
        fechaLimite.setDate(fechaLimite.getDate() - 30);
        const fechaLimiteStr = fechaLimite.toISOString().split('T')[0];

        console.log('Buscando publicaciones con fecha <=', fechaLimiteStr);

        const { data: publicaciones, error } = await supabase
          .from('publicacion')
          .select(`*, foto (*)`)
          .eq('estado', 'Activa')
          .eq('permiso_oferta', true)
          .lte('fecha_publicacion', fechaLimiteStr);

        if (error) {
          console.error('Error cargando ofertas:', error);
          return;
        }

        console.log('Publicaciones en ofertas encontradas:', publicaciones);
        procesarPublicaciones(publicaciones || []);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function procesarPublicaciones(publicaciones) {
  DATA = publicaciones.map(pub => {
    const primeraFoto = pub.foto && pub.foto.length > 0 ? pub.foto[0].url : null;
    
    // PARA OFERTAS: Siempre usar precio_oferta (10% descuento)
    const precioOferta = Math.round(pub.precio * 0.9);
    
    return {
      id: pub.id_publicacion,
      nombre: pub.titulo,
      precio: pub.precio,
      precio_oferta: precioOferta, // ‚Üê Siempre con descuento en ofertas
      permiso_oferta: true, // ‚Üê Forzar a true en ofertas
      club: pub.club,
      pais: 'Uruguay',
      categoria: formatCategoria(pub.categoria),
      img: primeraFoto || PLACEHOLDER,
      talle: pub.talle,
      condicion: pub.condicion,
      autenticidad: pub.autenticidad,
      stock: pub.stock,
      descripcion: pub.descripcion,
      sellerId: pub.id_usuario,
      fotos: pub.foto || []
    }
  });

  console.log('DATA procesada:', DATA);

  // Inicializar favoritos despu√©s de cargar DATA
  if (window.initializeFavorites) {
    window.initializeFavorites();
  }
  
  // Inicializar toda la UI
  if (window.inicializarUI) {
    window.inicializarUI();
  }
}

    function formatCategoria(cat) {
      if (!cat) return 'Club';
      if (cat === 'Seleccion') return 'Selecci√≥n';
      return cat;
    }

    // Inicializar
    await refreshHeader();
    await cargarPublicacionesOfertas();

    supabase.auth.onAuthStateChange(() => refreshHeader());

    // Men√∫ del usuario
    userWdg.addEventListener('click', (e)=>{
      if(e.target.closest('#userMenu')) return
      userMenu.classList.toggle('hidden')
    })
    document.addEventListener('click', (e)=>{
      if(!userWdg.contains(e.target)) userMenu.classList.add('hidden')
    })
    logoutBtn.addEventListener('click', async (e)=>{
      e.preventDefault()
      await supabase.auth.signOut()
      location.reload()
    })
  </script>
</body>
</html>