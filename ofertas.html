<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ofertas ‚Äî La Otra Tribuna</title>
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="stylesheet" href="styles/mobile.css" />
  <script src="scripts/mobile-nav.js" defer></script>
  <link rel="stylesheet" href="styles/user-widget.css" />
  <link rel="stylesheet" href="styles/notifications.css" />
  <link rel="icon" type="image/png" href="./assets/logo.png" />
  <style>
    /* Para que la barra llegue completa al m√°ximo */
    #price.range{ width:100%; background:linear-gradient(to right,#064e3b 100%,#e5e7eb 0%) }
    #price.range::-webkit-slider-runnable-track{ background:linear-gradient(to right,#064e3b var(--percent,100%),#e5e7eb var(--percent,100%)) }
    #price.range::-moz-range-track{ background:linear-gradient(to right,#064e3b var(--percent,100%),#e5e7eb var(--percent,100%)) }

    /* ===== Hero Ofertas ===== */
    .hero-ofertas{
      background:url('./assets/oferta3.png') center/cover no-repeat;
      min-height:280px; display:flex; flex-direction:column; align-items:center; justify-content:flex-end;
      text-align:center; color:#fff; padding-bottom:20px;
    }
    .hero-ofertas .copy h1{ margin:0; font-weight:800; font-size:clamp(24px,4vw,40px) }
    .hero-ofertas .hero-sub{ margin-top:6px; opacity:.95; font-size:clamp(14px,2.2vw,18px) }
  </style>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header id="siteHeader">
    <div class="top container">
      <div class="brand-wrap">
        <a href="index.html" class="logo-link" aria-label="Ir al inicio">
          <img class="logo" src="./assets/logo.png" alt="La Otra Tribuna" />
        </a>
      </div>

      <div class="search">
        <input id="q" type="search" placeholder="Buscar club o pa√≠s‚Ä¶" autocomplete="off" />
      </div>

      <div class="header-messages" id="headerMessage">Aprovech√° las mejores ofertas</div>

      <div class="actions" style="display:flex;align-items:center;gap:12px;">
        <!-- Bot√≥n por defecto (si NO hay sesi√≥n) -->
        <a id="loginBtn" href="login.html" class="btn-login">Iniciar sesi√≥n</a>

        <!-- Widget de usuario (oculto hasta que haya sesi√≥n) -->
        <div id="userWidget" class="user-widget hidden" aria-live="polite" style="position:relative;">
          <div id="userAvatar" class="user-avatar" title="Mi perfil"></div>
          <span id="greeting" class="user-greeting"></span>
          <div id="userMenu" class="user-menu hidden">
            <a href="perfil.html">üë§ Perfil</a>
            <a href="mis_publicaciones.html">üìä Mis Publicaciones</a>
            <a href="mis-pedidos.html">üßæ Mis pedidos</a>
            <a href="#" id="logoutBtn">üö™ Cerrar sesi√≥n</a>
          </div>
        </div>

        <!-- Tus botones existentes -->
        <button class="pill" id="favBtn" aria-label="Abrir favoritos">‚ù§Ô∏è<span id="favCount">0</span></button>
        <button class="pill" id="cartBtn" aria-label="Abrir carrito">üõí <span id="cartCount">0</span></button>
      </div>
    </div>
    <button class="burger" aria-expanded="false" aria-controls="mnav" aria-label="Abrir men√∫">
      <span>‚â°</span>
    </button>


    <!-- ===== SUBNAV ===== -->
    <nav class="subnav">
      <div class="container subnav-inner">
        <div class="subnav-left">
          <a href="#ubicacion" class="loc-link" id="openLocation">
            <svg class="loc-ic" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22s7-6.46 7-12a7 7 0 1 0-14 0c0 5.54 7 12 7 12Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <span class="loc-line" id="locText">Enviar a <strong>Montevideo</strong></span>
          </a>
        </div>

        <div class="subnav-center">
          <div class="has-submenu" id="catsDrop">
            <a href="index.html" class="subnav-link" id="catsLink" aria-haspopup="true" aria-expanded="false">
              Categor√≠as <span class="chev" aria-hidden="true">‚ñæ</span>
            </a>
            <div class="cat-submenu" id="catsMenu" role="menu" aria-label="Categor√≠as">
              <a href="index.html?cat=club#catalogo">Club</a>
              <a href="index.html?cat=seleccion#catalogo">Selecci√≥n</a>
              <a href="index.html?cat=retro#catalogo">Retro</a>
            </div>
          </div>
          <a href="ofertas.html" class="subnav-link">Ofertas</a>
          <a href="vender.html" class="subnav-link">Vender</a>
          <a href="rastrear.html" class="subnav-link">Rastrear Pedido</a>
        </div>

        <div class="subnav-right">
          <a href="favoritos.html" class="subnav-link" id="favLink">Favoritos</a>
          <a href="como-funciona.html" class="subnav-link">C√≥mo funciona</a>
          <a href="autenticidad.html" class="subnav-link">Autenticidad</a>
          <a href="ayuda.html" class="subnav-link">Ayuda</a>
        </div>
      </div>
    </nav>

    <nav id="mnav" class="mnav" role="dialog" aria-modal="true" aria-label="Men√∫">
      <div class="mnav-head">
        <strong>Men√∫</strong>
        <button type="button" class="close-mnav" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="mnav-search">
        <input id="mq" type="search" placeholder="Buscar camisetas‚Ä¶" autocomplete="off" />
        <div id="msearchMenu" class="search-menu" hidden></div>
      </div>
      <div class="mnav-links">
        <a href="index.html">Inicio</a>
        <a href="ofertas.html">Ofertas</a>
        <a href="vender.html">Vender</a>
        <a href="rastrear.html">Rastrear Pedido</a>
        <a href="favoritos.html">Favoritos</a>
        <a href="como-funciona.html">C√≥mo funciona</a>
        <a href="autenticidad.html">Autenticidad</a>
        <a href="ayuda.html">Ayuda</a>
      </div>
    </nav>

  <!-- Si la p√°gina no lo tiene todav√≠a: -->
  <div id="overlay" class="overlay"></div>

  </header>

  <!-- ===== HERO OFERTAS ===== -->
  <section class="hero hero-ofertas">
    <div class="copy">
      <h1>Los mejores descuentos</h1>
      <p class="hero-sub">Aprovech√° nuestras promos por tiempo limitado.</p>
    </div>
  </section>

  <!-- ===== OVERLAY UBICACI√ìN ===== -->
  <div id="overlay" class="overlay"></div>
  <div id="locationModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Elige d√≥nde recibir tus compras</h3>
        <button class="modal-close" id="closeLocation" aria-label="Cerrar">‚úï</button>
      </div>
      <form id="locForm" class="loc-form" autocomplete="off">
        <div class="field">
          <label for="departamento">Departamento</label>
          <select id="departamento" required>
            <option value="" selected>Elija una opci√≥n</option>
          </select>
        </div>
        <div class="field">
          <label for="localidad">Localidad</label>
          <select id="localidad" required disabled>
            <option value="" selected>Elija una opci√≥n</option>
          </select>
        </div>
        <div class="actions-row">
          <button type="button" class="btn" id="cancelLoc">Cancelar</button>
          <button type="submit" class="btn primary" id="acceptLoc" disabled>Aceptar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== CONTENIDO ===== -->
  <main>
    <div class="container">
      <section id="catalogo" style="padding-top:20px">
        <h2>Ofertas</h2>
        <p class="muted">Resultados: <span id="count">0</span></p>
        <div id="grid" class="grid"></div>
      </section>

      <footer>¬©Ô∏è <span id="year"></span> La Otra Tribuna.</footer>
    </div>
  </main>

  <script>
    // ===== Datos demo =====
    const DATA = [
      {id:1,nombre:'Camiseta Local 24/25',club:'Barcelona',pais:'Espa√±a',categoria:'Club',precio:3290,oferta:true,desc:15,img:'./assets/camisetas/barcelona-local.jpg'},
      {id:2,nombre:'Camiseta Visitante 24/25',club:'Barcelona',pais:'Espa√±a',categoria:'Club',precio:3190,oferta:false,desc:0,img:'./assets/camisetas/barcelona-visitante.jpg'},
      {id:3,nombre:'Camiseta Titular 24/25',club:'Real Madrid',pais:'Espa√±a',categoria:'Club',precio:3490,oferta:true,desc:10,img:'./assets/camisetas/real-madrid-titular.jpg'},
      {id:4,nombre:'Camiseta Selecci√≥n 24/25',club:'Uruguay',pais:'Uruguay',categoria:'Selecci√≥n',precio:2990,oferta:true,desc:20,img:'./assets/camisetas/uruguay-seleccion.jpg'}
    ];
    const PLACEHOLDER = 'https://placehold.co/600x750?text=Camiseta';
    const uy = new Intl.NumberFormat('es-UY',{style:'currency',currency:'UYU',maximumFractionDigits:0});

    const grid = document.getElementById('grid');
    const count = document.getElementById('count');
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== Favoritos (localStorage) =====
    const favorites = new Set(JSON.parse(localStorage.getItem('lot_favorites') || '[]'));
    function saveFavorites(){ localStorage.setItem('lot_favorites', JSON.stringify([...favorites])); }

    // ===== Render grilla solo con ofertas =====
    function priceWithDiscount(p, d){ return Math.round(p * (1 - d/100)); }

    function render(){
      const items = DATA.filter(p => p.oferta);
      count.textContent = items.length;
      grid.innerHTML = '';

      for(const p of items){
        const finalPrice = priceWithDiscount(p.precio, p.desc || 0);
        const el = document.createElement('article');
        el.className = 'card';
        el.innerHTML = `
          <div class="media">
            <img src="${p.img}" alt="${p.nombre}" loading="lazy" onerror="this.src='${PLACEHOLDER}'">
            <span class="badge" style="position:absolute;left:8px;top:8px;background:#d92d20;color:#fff;border-radius:999px;padding:4px 8px;font-size:12px">-${p.desc}%</span>
            <button class="fav-toggle ${favorites.has(p.id)?'active':''}" data-fav-id="${p.id}" title="Agregar a favoritos">
              ${favorites.has(p.id)?'‚ù§Ô∏è':'ü§ç'}
            </button>
          </div>
          <div class="body">
            <div class="meta">
              <div>
                <div style="font-weight:700;font-size:16px;line-height:1.2">${p.nombre}</div>
                <div class="muted">${p.club} ‚Ä¢ ${p.categoria}</div>
              </div>
              <div class="price">
                <div style="font-weight:700">${uy.format(finalPrice)}</div>
                <div class="muted" style="text-decoration:line-through;font-size:12px">${uy.format(p.precio)}</div>
              </div>
            </div>
            <button class="btn primary" data-id="${p.id}">Agregar al carrito</button>
          </div>`;
        grid.appendChild(el);
      }
    }

    function updateGridFavIcons(){
      document.querySelectorAll('.fav-toggle').forEach(btn=>{
        const id = Number(btn.dataset.favId);
        btn.classList.toggle('active', favorites.has(id));
        btn.textContent = favorites.has(id) ? '‚ù§Ô∏è' : 'ü§ç';
      });
    }

    grid.addEventListener('click', (e)=>{
      const addBtn = e.target.closest('button[data-id]');
      const favBtn = e.target.closest('.fav-toggle');

      if(addBtn){
        const id = Number(addBtn.dataset.id);
        const key = 'lot_cart_demo';
        const cart = new Map(Object.entries(JSON.parse(localStorage.getItem(key) || '{}')).map(([k,v])=>[+k,v]));
        cart.set(id, (cart.get(id)||0)+1);
        localStorage.setItem(key, JSON.stringify(Object.fromEntries(cart)));
        addBtn.textContent = 'Agregado ‚úì';
        setTimeout(()=> addBtn.textContent = 'Agregar al carrito', 900);
        alert('Agregado al carrito (demo)');
        return;
      }
      if(favBtn){
        const id = Number(favBtn.dataset.favId);
        if(favorites.has(id)) favorites.delete(id); else favorites.add(id);
        saveFavorites(); updateGridFavIcons(); return;
      }
    });

    render(); updateGridFavIcons();

    // ===== Ubicaci√≥n =====
    const LOCATION_KEY = 'lot_location';
    const overlay = document.getElementById('overlay');
    const locationModal = document.getElementById('locationModal');
    const openLocationBtn = document.getElementById('openLocation');
    const closeLocationBtn = document.getElementById('closeLocation');
    const cancelLocBtn = document.getElementById('cancelLoc');
    const deptSel = document.getElementById('departamento');
    const locSel = document.getElementById('localidad');
    const acceptLocBtn = document.getElementById('acceptLoc');
    const locText = document.getElementById('locText');

    const DEPTS = {
      "Artigas":["Artigas","Bella Uni√≥n","Tom√°s Gomensoro","Baltasar Brum"],
      "Canelones":["Canelones","Ciudad de la Costa","Las Piedras","Pando","La Paz","Progreso","Santa Luc√≠a","Atl√°ntida","Parque del Plata","Sauce","San Ram√≥n","Empalme Olmos","Toledo"],
      "Colonia":["Colonia del Sacramento","Carmelo","Nueva Helvecia","Juan Lacaze","Rosario","Tarariras","Omb√∫es de Lavalle"],
      "Durazno":["Durazno","Sarand√≠ del Y√≠","Carmen","Centenario"],
      "Maldonado":["Maldonado","Punta del Este","San Carlos","Piri√°polis","Pan de Az√∫car","Aigu√°","La Barra"],
      "Montevideo":["Montevideo"],
      "Paysand√∫":["Paysand√∫","Guich√≥n","Quebracho","Piedras Coloradas"],
      "Rocha":["Rocha","Chuy","Castillos","Lascano","La Paloma","Punta del Diablo"],
      "Salto":["Salto","Constituci√≥n","Bel√©n","Daym√°n","San Antonio"],
      "San Jos√©":["San Jos√© de Mayo","Ciudad del Plata","Libertad","Ecilda Paullier"],
      "Soriano":["Mercedes","Dolores","Cardona"],
      "Tacuaremb√≥":["Tacuaremb√≥","Paso de los Toros"],
      "Treinta y Tres":["Treinta y Tres","Vergara"]
    };

    function fillDept(){ Object.keys(DEPTS).forEach(d => deptSel.append(new Option(d,d))); }
    function renderLocationText(){
      const raw = localStorage.getItem(LOCATION_KEY);
      if(!raw){ locText.innerHTML = 'Ingresa tu <strong>ubicaci√≥n</strong>'; return; }
      try{ const {loc} = JSON.parse(raw); locText.textContent = `Enviar a ${loc}`; }
      catch{ locText.innerHTML = 'Ingresa tu <strong>ubicaci√≥n</strong>'; }
    }
    function showOverlay(){ overlay.classList.add('show'); }
    function hideOverlay(){ overlay.classList.remove('show'); }
    function openLocation(){ locationModal.classList.add('open'); showOverlay(); }
    function closeLocation(){ locationModal.classList.remove('open'); hideOverlay(); }

    openLocationBtn.addEventListener('click', (e)=>{ e.preventDefault(); openLocation(); });
    closeLocationBtn?.addEventListener('click', closeLocation);
    cancelLocBtn?.addEventListener('click', closeLocation);
    overlay.addEventListener('click', closeLocation);

    deptSel.addEventListener('change', ()=>{
      const dept = deptSel.value;
      locSel.innerHTML = '<option value="" selected>Elija una opci√≥n</option>';
      if(!dept){ locSel.disabled = true; acceptLocBtn.disabled = true; return; }
      (DEPTS[dept] || []).forEach(l => locSel.append(new Option(l,l)));
      locSel.disabled = false; acceptLocBtn.disabled = true;
    });
    locSel.addEventListener('change', ()=> acceptLocBtn.disabled = !locSel.value);
    document.getElementById('locForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!deptSel.value || !locSel.value) return;
      localStorage.setItem(LOCATION_KEY, JSON.stringify({dept:deptSel.value, loc:locSel.value}));
      renderLocationText(); closeLocation();
    });

    fillDept(); renderLocationText();

    // (En ofertas no abrimos panel de favoritos ‚Äî solo persistimos la lista)
  </script>

  <!-- ===== NOTIFICACIONES: SOLO EL JS (sin HTML adicional) ===== -->
  <script type="module" src="scripts/notifications.js"></script>

  <!-- ===== SUPABASE: saludo ‚ÄúHola, Ignacio!‚Äù ===== -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = 'https://imexctmcesopdfdebsgo.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZXhjdG1jZXNvcGRmZGVic2dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDczMDIsImV4cCI6MjA3NDg4MzMwMn0.g1lziVKAuUvMEOkYxJhe2D2z8PlwGJ6xcXo_SSpTj7Q' 

    const supabase  = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    const loginBtn  = document.getElementById('loginBtn')
    const userWdg   = document.getElementById('userWidget')
    const avatarEl  = document.getElementById('userAvatar')
    const greetEl   = document.getElementById('greeting')
    const userMenu  = document.getElementById('userMenu')
    const logoutBtn = document.getElementById('logoutBtn')

    const initialsFrom = (n='',a='',e='')=>{
      const ini = (n.trim().split(/\s+/)[0]?.[0]||'') + (a.trim().split(/\s+/)[0]?.[0]||'')
      return (ini || (e?.[0]||'?')).toUpperCase()
    }
    const firstNameFrom = (n='',e='')=>{
      const f = n.trim().split(/\s+/)[0]
      return f || (e||'').split('@')[0]
    }

    async function refreshHeader(){
      const { data:{ session } } = await supabase.auth.getSession()
      if(!session){
        userWdg.classList.add('hidden')
        loginBtn.classList.remove('hidden')
        return
      }
      const uid = session.user.id
      let nombre='', apellido='', email=session.user.email||''
      try{
        const { data: perfil } = await supabase
          .from('usuario')
          .select('nombre, apellido, email')
          .eq('id_auth', uid)
          .maybeSingle()
        if(perfil){
          nombre  = perfil.nombre   || session.user.user_metadata?.nombre   || ''
          apellido= perfil.apellido || session.user.user_metadata?.apellido || ''
          email   = perfil.email    || email
        }else{
          nombre   = session.user.user_metadata?.nombre   || ''
          apellido = session.user.user_metadata?.apellido || ''
        }
      }catch(_){}

      avatarEl.textContent = initialsFrom(nombre, apellido, email)
      greetEl.textContent  = `Hola, ${firstNameFrom(nombre, email)}!`
      loginBtn.classList.add('hidden')
      userWdg.classList.remove('hidden')
    }

    await refreshHeader()
    supabase.auth.onAuthStateChange(()=>refreshHeader())

    // Men√∫ del usuario
    userWdg.addEventListener('click', (e)=>{
      if(e.target.closest('#userMenu')) return
      userMenu.classList.toggle('hidden')
    })
    document.addEventListener('click', (e)=>{
      if(!userWdg.contains(e.target)) userMenu.classList.add('hidden')
    })
    logoutBtn.addEventListener('click', async (e)=>{
      e.preventDefault()
      await supabase.auth.signOut()
      location.reload()
    })
  </script>
</body>
</html>