<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Favoritos ‚Äî La Otra Tribuna</title>
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="stylesheet" href="styles/mobile.css" />
  <script src="scripts/mobile-nav.js" defer></script>
  <link rel="stylesheet" href="styles/user-widget.css" />
  <link rel="stylesheet" href="styles/notifications.css" />
  <link rel="icon" type="image/png" href="./assets/logo.png" />
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header id="siteHeader">
    <div class="top container">
      <div class="brand-wrap">
        <a href="index.html" class="logo-link" aria-label="Ir al inicio">
          <img class="logo" src="./assets/logo.png" alt="La Otra Tribuna">
        </a>
      </div>

      <div class="search">
        <input type="search" placeholder="Buscar club o pa√≠s‚Ä¶" autocomplete="off" />
      </div>

      <div class="header-messages" id="headerMessage">Tus favoritos, siempre a mano</div>

      <div class="actions" style="display:flex;align-items:center;gap:12px;">
        <!-- Bot√≥n por defecto (si no hay sesi√≥n) -->
        <a id="loginBtn" href="login.html" class="btn-login">Iniciar sesi√≥n</a>

        <!-- Widget usuario (con sesi√≥n) -->
        <div id="userWidget" class="user-widget hidden" aria-live="polite">
          <div id="userAvatar" class="user-avatar" title="Mi perfil"></div>
          <span id="greeting" class="user-greeting"></span>

          <!-- Men√∫ -->
          <div id="userMenu" class="user-menu hidden">
            <a href="perfil.html">üë§ Perfil</a>
            <a href="mis_publicaciones.html">üì¶ Mis publicaciones</a>
            <a href="mis-pedidos.html">üßæ Mis pedidos</a>
            <a href="#" id="logoutBtn" class="menu-divider">üö™ Cerrar sesi√≥n</a>
          </div>
        </div>
        <!-- La campana de notificaciones se inyecta aqu√≠ por notifications.js -->
      </div>
    </div>
    <button class="burger" aria-expanded="false" aria-controls="mnav" aria-label="Abrir men√∫">
      <span>‚â°</span>
    </button>

    <!-- ===== SUBNAV ===== -->
    <nav class="subnav">
      <div class="container subnav-inner">
        <div class="subnav-left">
          <!-- bot√≥n/estado de ubicaci√≥n -->
          <a href="#ubicacion" class="loc-link" id="openLocation">
            <svg class="loc-ic" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22s7-6.46 7-12a7 7 0 1 0-14 0c0 5.54 7 12 7 12Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <span class="loc-line" id="locText">Ingresa tu <strong>ubicaci√≥n</strong></span>
          </a>
        </div>

        <div class="subnav-center">
          <div class="has-submenu" id="catsDrop">
            <a href="index.html" class="subnav-link" id="catsLink" aria-haspopup="true" aria-expanded="false">
              Categor√≠as <span class="chev" aria-hidden="true">‚ñæ</span>
            </a>
            <div class="cat-submenu" id="catsMenu" role="menu" aria-label="Categor√≠as">
              <a href="index.html?cat=club#catalogo">Club</a>
              <a href="index.html?cat=seleccion#catalogo">Selecci√≥n</a>
              <a href="index.html?cat=retro#catalogo">Retro</a>
            </div>
          </div>
          <a href="ofertas.html" class="subnav-link">Ofertas</a>
          <a href="vender.html" class="subnav-link">Vender</a>
          <a href="rastrear.html" class="subnav-link">Rastrear Pedido</a>
        </div>

        <div class="subnav-right">
          <a href="favoritos.html" class="subnav-link">Favoritos</a>
          <a href="como-funciona.html" class="subnav-link">C√≥mo funciona</a>
          <a href="autenticidad.html" class="subnav-link">Autenticidad</a>
          <a href="ayuda.html" class="subnav-link">Ayuda</a>
        </div>
      </div>
    </nav>

    <!-- Men√∫ m√≥vil -->
    <nav id="mnav" class="mnav" role="dialog" aria-modal="true" aria-label="Men√∫">
      <div class="mnav-head">
        <strong>Men√∫</strong>
        <button type="button" class="close-mnav" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="mnav-search">
        <input id="mq" type="search" placeholder="Buscar camisetas‚Ä¶" autocomplete="off" />
        <div id="msearchMenu" class="search-menu" hidden></div>
      </div>
      <div class="mnav-links">
        <a href="index.html">Inicio</a>
        <a href="ofertas.html">Ofertas</a>
        <a href="vender.html">Vender</a>
        <a href="rastrear.html">Rastrear Pedido</a>
        <a href="favoritos.html">Favoritos</a>
        <a href="como-funciona.html">C√≥mo funciona</a>
        <a href="autenticidad.html">Autenticidad</a>
        <a href="ayuda.html">Ayuda</a>
      </div>
    </nav>
  </header>

  <!-- ===== Overlay + MODAL UBICACI√ìN (√∫nicos) ===== -->
  <div id="overlay" class="overlay"></div>

  <div id="locationModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Elige d√≥nde recibir tus compras</h3>
        <button class="modal-close" id="closeLocation" aria-label="Cerrar">‚úï</button>
      </div>
      <form id="locForm" class="loc-form" autocomplete="off">
        <div class="field">
          <label for="departamento">Departamento</label>
          <select id="departamento" required>
            <option value="" selected>Elija una opci√≥n</option>
          </select>
        </div>
        <div class="field">
          <label for="localidad">Localidad</label>
          <select id="localidad" required disabled>
            <option value="" selected>Elija una opci√≥n</option>
          </select>
        </div>
        <div class="actions-row">
          <button type="button" class="btn" id="cancelLoc">Cancelar</button>
          <button type="submit" class="btn primary" id="acceptLoc" disabled>Aceptar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== CONTENIDO ===== -->
  <main class="container">
    <div class="info-wrap">
      <h1>Favoritos</h1>
      <p class="lead">Guard√° y compar√° las camisetas que m√°s te gustan.</p>

      <!-- Estado vac√≠o / grilla (dejalo como uses en tu CSS/JS) -->
      <section id="fav-empty" class="empty-state" hidden>
        <p>No ten√©s camisetas en Favoritos todav√≠a.</p>
        <a class="btn" href="index.html#catalogo">Explorar cat√°logo</a>
      </section>

      <section id="fav-grid" class="grid" aria-live="polite"></section>
    </div>
  </main>

  <!-- ===== SCRIPT UBICACI√ìN ===== -->
  <script src="scripts/uy-depts.js"></script>
  <script>
    // Mensaje fijo del header
    document.getElementById('headerMessage').textContent = 'Tus favoritos, siempre a mano';

    // ====== UBICACI√ìN ======
    const LOCATION_KEY = 'lot_location';
    const overlay = document.getElementById('overlay');
    const openLocationBtn = document.getElementById('openLocation');
    const locationModal = document.getElementById('locationModal');
    const closeLocationBtn = document.getElementById('closeLocation');
    const cancelLocBtn = document.getElementById('cancelLoc');
    const deptSel = document.getElementById('departamento');
    const locSel = document.getElementById('localidad');
    const acceptLocBtn = document.getElementById('acceptLoc');
    const locText = document.getElementById('locText');

    // Usar DEPTS del archivo externo
    const DEPTS = window.UY_DEPTS || {"Montevideo":["Montevideo"]};

    function fillDept(){ 
      Object.keys(DEPTS).forEach(d => deptSel.append(new Option(d,d))); 
    }
    
    function renderLocationText(){
      const raw = localStorage.getItem(LOCATION_KEY);
      if(!raw){ 
        locText.innerHTML = 'Ingresa tu <strong>ubicaci√≥n</strong>'; 
        return; 
      }
      try{ 
        const {loc} = JSON.parse(raw); 
        locText.textContent = `Enviar a ${loc}`; 
      }
      catch{ 
        locText.innerHTML = 'Ingresa tu <strong>ubicaci√≥n</strong>'; 
      }
    }

    function openLocationModal() {
      locationModal.classList.add('open');
      overlay.classList.add('show');
      document.body.classList.add('modal-open');
    }
    
    function closeLocationModal() {
      locationModal.classList.remove('open');
      overlay.classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    openLocationBtn.addEventListener('click', (e)=>{ 
      e.preventDefault(); 
      openLocationModal(); 
    });
    
    closeLocationBtn?.addEventListener('click', closeLocationModal);
    cancelLocBtn?.addEventListener('click', closeLocationModal);
    overlay.addEventListener('click', closeLocationModal);

    deptSel.addEventListener('change', ()=>{
      const dept = deptSel.value;
      locSel.innerHTML = '<option value="" selected>Elija una opci√≥n</option>';
      if(!dept){ 
        locSel.disabled = true; 
        acceptLocBtn.disabled = true; 
        return; 
      }
      (DEPTS[dept] || []).forEach(loc => locSel.append(new Option(loc,loc)));
      locSel.disabled = false; 
      acceptLocBtn.disabled = true;
    });

    locSel.addEventListener('change', ()=> acceptLocBtn.disabled = !locSel.value);

    document.getElementById('locForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!deptSel.value || !locSel.value) return;
      localStorage.setItem(LOCATION_KEY, JSON.stringify({dept:deptSel.value, loc:locSel.value}));
      renderLocationText(); 
      closeLocation();
      window.dispatchEvent(new CustomEvent('lotr:location-changed'));
    });

    fillDept(); 
    renderLocationText();

    // Sombra header
    const siteHeader = document.getElementById('siteHeader');
    const onScroll = ()=> siteHeader.classList.toggle('is-scrolled', window.scrollY > 0);
    onScroll(); 
    window.addEventListener('scroll', onScroll, {passive:true});

    // Submen√∫ categor√≠as en mobile
    const catsDrop = document.getElementById('catsDrop');
    const catsLink = document.getElementById('catsLink');
    catsLink?.addEventListener('click', (e)=>{
      if (window.matchMedia('(max-width: 820px)').matches){
        e.preventDefault();
        catsDrop.classList.toggle('open');
      }
    });
    document.addEventListener('click', (e)=>{
      if(!catsDrop.contains(e.target)) catsDrop.classList.remove('open');
    });

    // ====== FAVORITOS (placeholder simple: usa tu l√≥gica si ya la ten√©s) ======
    const favGrid = document.getElementById('fav-grid');
    const favEmpty = document.getElementById('fav-empty');
    const FAV_KEY = 'lot_favs';
    function loadFavs(){
      let items = [];
      try { items = JSON.parse(localStorage.getItem(FAV_KEY) || '[]'); } catch {}
      if(!items.length){
        favEmpty.hidden = false;
        favGrid.innerHTML = '';
        return;
      }
      favEmpty.hidden = true;
      favGrid.innerHTML = items.map(it => `
        <article class="card">
          <img src="${it.img || './assets/placeholder.png'}" alt="${it.title || 'Camiseta'}" />
          <div class="card-body">
            <h3>${it.title || 'Camiseta'}</h3>
            <p>${it.team || ''} ${it.season ? '¬∑ ' + it.season : ''}</p>
            <strong>${it.price ? '$ ' + it.price : ''}</strong>
          </div>
        </article>
      `).join('');
    }
    loadFavs();
    window.addEventListener('storage', e => { if(e.key === FAV_KEY) loadFavs(); });
  </script>

  <!-- ===== SCRIPTS COMPARTIDOS ===== -->
  <!-- Notificaciones -->
  <script src="scripts/notifications.js"></script>

  <!-- Widget de usuario centralizado (maneja sesi√≥n, saludo, men√∫ y logout) -->
  <script type="module" src="scripts/user-widget.js"></script>

  <script>
    // Montar campana en el contenedor de acciones del header
    window.NotificationsConfig = Object.assign(
      { containerSelector: '.actions' },
      window.NotificationsConfig || {}
    );
    document.addEventListener('DOMContentLoaded', () => {
      if (window.Notifications && typeof window.Notifications.mount === 'function') {
        window.Notifications.mount();
      }
    });
  </script>
</body>
</html>