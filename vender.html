<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vender â€” La Otra Tribuna</title>

  <link rel="stylesheet" href="styles/main.css" />
  <link rel="stylesheet" href="styles/mobile.css" />
  <script src="scripts/mobile-nav.js" defer></script>
  <link rel="stylesheet" href="styles/user-widget.css" />
  <link rel="stylesheet" href="styles/notifications.css" />

  <style>
    body {
      background: url('./assets/venta.png') no-repeat center top;
      background-size: cover;
      background-attachment: fixed;
      min-height: 100vh;
      overflow-x: hidden;
    }
    body::before { 
      content:""; 
      position: fixed; 
      inset:0; 
      background:rgba(255,255,255,.4); 
      z-index:-1; 
      pointer-events: none;
    }
    .sell-card { 
      background:#fff; 
      border-radius:12px; 
      border:1px solid #e5e7eb; 
      padding:24px; 
      max-width:640px; 
      margin:40px auto;
      box-shadow:0 4px 12px rgba(0,0,0,.08); 
    }
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      gap: 16px;
      position: fixed;
      inset: 0;
      background: white;
      z-index: 9999;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .track-full {
      min-height: calc(100vh - 200px);
      padding: 20px 16px;
      position: relative;
      z-index: 1;
    }

    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .overlay.show { display: block; }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 1001;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal.open { display: block; }

    body.modal-open { overflow: hidden; }
    body:not(.modal-open) { overflow-y: auto; }

    /* ====== Ã‰XITO centrado (check verde) ====== */
    .success-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.35);
      z-index: 1200;
      backdrop-filter: blur(1px);
    }
    .success-overlay.show { display: flex; }

    .success-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 24px 22px;
      min-width: 280px;
      max-width: 90vw;
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      text-align: center;
      animation: pop .18s ease-out;
    }
    @keyframes pop {
      from { transform: scale(.96); opacity: .9; }
      to   { transform: scale(1);   opacity: 1; }
    }
    .success-icon-wrap {
      width: 56px; height: 56px; border-radius: 50%;
      background: #22c55e20; display:flex; align-items:center; justify-content:center;
    }
    .success-icon {
      width: 28px; height: 28px; color: #16a34a;
      transform: scale(.9);
      animation: grow .22s ease-out forwards;
    }
    @keyframes grow { to { transform: scale(1); } }
    .success-title { font-weight: 700; font-size: 18px; }
    .success-text  { color: #6b7280; font-size: 14px; }
    .success-sub   { color: #6b7280; font-size: 13px; }
  </style>
</head>
<body>
  <!-- LOADING -->
  <div id="loading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Verificando acceso...</p>
  </div>

  <!-- HEADER -->
  <header id="siteHeader" style="display:none;">
    <div class="top container">
      <div class="brand-wrap">
        <a href="index.html" class="logo-link" aria-label="Ir al inicio">
          <img class="logo" src="./assets/logo.png" alt="La Otra Tribuna" />
        </a>
      </div>

      <div class="search">
        <input id="q" type="search" placeholder="Buscar club o paÃ­sâ€¦" autocomplete="off" />
        <div id="searchMenu" class="search-menu" hidden></div>
      </div>

      <div class="header-messages">PublicÃ¡ tu camiseta en segundos</div>

      <div class="actions" style="display:flex;align-items:center;gap:12px;">
        <a id="loginBtn" href="login.html" class="btn-login">Iniciar sesiÃ³n</a>

        <!-- Widget de usuario -->
        <div id="userWidget" class="user-widget hidden" aria-live="polite" style="position:relative;">
          <div id="userAvatar" class="user-avatar" title="Mi perfil"></div>
          <span id="greeting" class="user-greeting"></span>
          <div id="userMenu" class="user-menu hidden">
            <a href="perfil.html">ðŸ‘¤ Perfil</a>
            <a href="mis_publicaciones.html">ðŸ“Š Mis Publicaciones</a>
            <a href="mis-pedidos.html">ðŸ§¾ Mis pedidos</a>
            <a href="#" id="logoutBtn" class="menu-divider">ðŸšª Cerrar sesiÃ³n</a>
          </div>
        </div>
      </div>
    </div>

    <button class="burger" aria-expanded="false" aria-controls="mnav" aria-label="Abrir menÃº">
      <span>â‰¡</span>
    </button>


    <nav class="subnav">
      <div class="container subnav-inner">
        <div class="subnav-left">
          <a href="#ubicacion" class="loc-link" id="openLocation">
            <svg class="loc-ic" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22s7-6.46 7-12a7 7 0 1 0-14 0c0 5.54 7 12 7 12Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <span class="loc-line" id="locText">Ingresa tu <strong>ubicaciÃ³n</strong></span>
          </a>
        </div>

        <div class="subnav-center">
          <div class="has-submenu" id="catsDrop">
            <a href="index.html" class="subnav-link" id="catsLink" aria-haspopup="true" aria-expanded="false">
              CategorÃ­as <span class="chev" aria-hidden="true">â–¾</span>
            </a>
            <div class="cat-submenu" id="catsMenu" role="menu" aria-label="CategorÃ­as">
              <a href="index.html?cat=club#catalogo">Club</a>
              <a href="index.html?cat=seleccion#catalogo">SelecciÃ³n</a>
              <a href="index.html?cat=retro#catalogo">Retro</a>
            </div>
          </div>
          <a href="ofertas.html" class="subnav-link">Ofertas</a>
          <a href="vender.html" class="subnav-link">Vender</a>
          <a href="rastrear.html" class="subnav-link">Rastrear Pedido</a>
        </div>

        <div class="subnav-right">
          <a href="favoritos.html" class="subnav-link">Favoritos</a>
          <a href="como-funciona.html" class="subnav-link">CÃ³mo funciona</a>
          <a href="autenticidad.html" class="subnav-link">Autenticidad</a>
          <a href="ayuda.html" class="subnav-link">Ayuda</a>
        </div>
      </div>
    </nav>

    <nav id="mnav" class="mnav" role="dialog" aria-modal="true" aria-label="MenÃº">
      <div class="mnav-head">
        <strong>MenÃº</strong>
        <button type="button" class="close-mnav" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="mnav-search">
        <input id="mq" type="search" placeholder="Buscar camisetasâ€¦" autocomplete="off" />
        <div id="msearchMenu" class="search-menu" hidden></div>
      </div>
      <div class="mnav-links">
        <a href="index.html">Inicio</a>
        <a href="ofertas.html">Ofertas</a>
        <a href="vender.html">Vender</a>
        <a href="rastrear.html">Rastrear Pedido</a>
        <a href="favoritos.html">Favoritos</a>
        <a href="como-funciona.html">CÃ³mo funciona</a>
        <a href="autenticidad.html">Autenticidad</a>
        <a href="ayuda.html">Ayuda</a>
      </div>
    </nav>
  </header>

  <!-- MODAL UBICACIÃ“N -->
  <div id="overlay" class="overlay"></div>
  <div id="locationModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="locTitle">Elige dÃ³nde recibir tus compras</h3>
        <button class="modal-close" id="closeLocation" aria-label="Cerrar">âœ•</button>
      </div>
      <p class="muted" style="margin:0 0 12px">PodrÃ¡s ver costos y tiempos de entrega precisos en todo lo que busques.</p>

      <form id="locForm" class="loc-form" autocomplete="off">
        <div class="field">
          <label for="departamento">Departamento</label>
          <select id="departamento" required>
            <option value="" selected>Elija una opciÃ³n</option>
          </select>
        </div>
        <div class="field">
          <label for="localidad">Localidad</label>
          <select id="localidad" required disabled>
            <option value="" selected>Elija una opciÃ³n</option>
          </select>
        </div>
        <div class="actions-row">
          <button type="button" class="btn" id="cancelLoc">Cancelar</button>
          <button type="submit" class="btn primary" id="acceptLoc" disabled>Aceptar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- CONTENIDO -->
  <main class="track-full" id="mainContent" style="display:none;">
    <div class="track-card sell-card">
      <div class="track-title">
        <img src="./assets/imagen.png" alt="" style="width:40px;height:40px;border-radius:8px;">
        <h2 style="margin:0;font-size:22px">Vender</h2>
      </div>

      <form class="track-form" id="sellForm">
        <div class="form-grid two-cols">
          <div class="field span-2">
            <label>Imagen de la publicaciÃ³n</label>
            <div class="image-field">
              <div class="image-drop" id="dropArea">
                <input type="file" id="imagen" accept="image/*" hidden>
                <img id="preview" alt="">
                <label for="imagen" class="btn">Subir imagen</label>
              </div>
              <p class="helper muted">SubÃ­ una foto clara de la camiseta. Solo se admite 1 imagen por ahora.</p>
            </div>
          </div>

          <div class="field span-2">
            <label for="equipo">Equipo</label>
            <input id="equipo" type="text" placeholder="Ej: Barcelona" required>
          </div>

          <div class="field span-2">
            <label for="titulo">TÃ­tulo</label>
            <input id="titulo" type="text" placeholder="Ej: Camiseta Barcelona 24/25" required>
          </div>

          <div class="field span-2">
            <label for="descripcion">DescripciÃ³n</label>
            <textarea id="descripcion" placeholder="Detalles sobre la camisetaâ€¦" required></textarea>
          </div>

          <div class="field">
            <label for="precio">Precio</label>
            <input id="precio" type="number" placeholder="Ej: 3500" required>
          </div>
          <div class="field">
            <label for="moneda">Moneda</label>
            <select id="moneda" required>
              <option value="UYU">UYU</option>
              <option value="USD">USD</option>
            </select>
          </div>

          <div class="field">
            <label for="condicion">CondiciÃ³n</label>
            <select id="condicion" required>
              <option value="Nuevo">Nuevo</option>
              <option value="Usado">Usado</option>
            </select>
          </div>
          <div class="field">
            <label for="auth">Autenticidad</label>
            <select id="auth" required>
              <option value="Original">Original</option>
              <option value="Replica">RÃ©plica</option>
            </select>
          </div>

          <div class="field">
            <label for="talle">Talle</label>
            <select id="talle" required>
              <option>XS</option><option>S</option><option>M</option>
              <option>L</option><option>XL</option><option>XXL</option><option>XXXL</option>
            </select>
          </div>
          <div class="field">
            <label for="stock">Stock</label>
            <input id="stock" type="number" min="0" placeholder="Ej: 10" required>
          </div>

          <div class="field span-2">
            <label>CategorÃ­a de la publicaciÃ³n</label>
            <div class="segmented">
              <input type="radio" id="categoria-club" name="categoria" value="Club" checked>
              <label for="categoria-club">Club</label>

              <input type="radio" id="categoria-seleccion" name="categoria" value="SelecciÃ³n">
              <label for="categoria-seleccion">SelecciÃ³n</label>

              <input type="radio" id="categoria-retro" name="categoria" value="Retro">
              <label for="categoria-retro">Retro</label>
            </div>
          </div>

          <div class="field span-2">
            <label>Estado de la publicaciÃ³n</label>
            <div class="segmented">
              <input type="radio" id="estado-activa" name="estado" value="Activa" checked>
              <label for="estado-activa">Activa</label>


              <input type="radio" id="estado-vendida" name="estado" value="Vendida">
              <label for="estado-vendida">Vendida</label>
            </div>
          </div>
        </div>

        <button type="submit" class="btn primary submit-full">Publicar</button>
      </form>
    </div>
  </main>

  <footer class="site-footer" style="display:none;">Â© <span id="year"></span> La Otra Tribuna.</footer>

  <!-- Ã‰xito centrado -->
  <div id="successOverlay" class="success-overlay" role="status" aria-live="polite" aria-atomic="true">
    <div class="success-card">
      <div class="success-icon-wrap" aria-hidden="true">
        <svg class="success-icon" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="11" stroke="#16a34a" stroke-width="1.5" fill="#22c55e22"></circle>
          <path d="M7 12.5l3.2 3.2L17 9" stroke="#16a34a" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="success-title" id="successTitle">Â¡PublicaciÃ³n creada!</div>
      <div class="success-text" id="successText">Tu publicaciÃ³n se guardÃ³ correctamente.</div>
    </div>
  </div>

  <!-- SCRIPTS BASE -->
  <script src="scripts/uy-depts.js"></script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const siteHeaderElement = document.getElementById('siteHeader');
    function onScroll(){ siteHeaderElement.classList.toggle('is-scrolled', window.scrollY > 0); }
    onScroll(); window.addEventListener('scroll', onScroll, {passive:true});

    const LOCATION_KEY = 'lot_location';
    const overlay = document.getElementById('overlay');
    const locationModal = document.getElementById('locationModal');
    const openLocationBtn = document.getElementById('openLocation');
    const closeLocationBtn = document.getElementById('closeLocation');
    const cancelLocBtn = document.getElementById('cancelLoc');
    const deptSel = document.getElementById('departamento');
    const locSel  = document.getElementById('localidad');
    const acceptLocBtn = document.getElementById('acceptLoc');
    const locText = document.getElementById('locText');
    const DEPTS = window.UY_DEPTS || {"Montevideo":["Montevideo"]};

    function fillDept(){ Object.keys(DEPTS).forEach(d => deptSel.append(new Option(d,d))); }
    function renderLocationText(){
      const raw = localStorage.getItem(LOCATION_KEY);
      if(!raw){ locText.innerHTML = 'Ingresa tu <strong>ubicaciÃ³n</strong>'; return; }
      try{ const {loc} = JSON.parse(raw); locText.textContent = `Enviar a ${loc}`; }
      catch{ locText.innerHTML = 'Ingresa tu <strong>ubicaciÃ³n</strong>'; }
    }

    function openLocationModal() {
      locationModal.classList.add('open');
      overlay.classList.add('show');
      document.body.classList.add('modal-open');
    }
    function closeLocationModal() {
      locationModal.classList.remove('open');
      overlay.classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    openLocationBtn.addEventListener('click', e=>{ e.preventDefault(); openLocationModal(); });
    closeLocationBtn.addEventListener('click', closeLocationModal);
    cancelLocBtn.addEventListener('click', closeLocationModal);
    overlay.addEventListener('click', closeLocationModal);

    deptSel.addEventListener('change', ()=>{
      locSel.innerHTML = '<option value="">Elija una opciÃ³n</option>';
      if(!deptSel.value){ locSel.disabled = true; acceptLocBtn.disabled = true; return; }
      (DEPTS[deptSel.value]||[]).forEach(l => locSel.append(new Option(l,l)));
      locSel.disabled = false; acceptLocBtn.disabled = true;
    });
    locSel.addEventListener('change', ()=>{ acceptLocBtn.disabled = !locSel.value; });

    document.getElementById('locForm').addEventListener('submit', e=>{
      e.preventDefault();
      localStorage.setItem(LOCATION_KEY, JSON.stringify({dept:deptSel.value, loc:locSel.value}));
      renderLocationText();
      closeLocationModal();
    });

    fillDept(); renderLocationText();

    // Imagen: preview + drag & drop
    const imgInput = document.getElementById('imagen');
    const imgPreview = document.getElementById('preview');
    const imgDropArea = document.getElementById('dropArea');

    imgInput?.addEventListener('change', e=>{
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ev => { imgPreview.src = ev.target.result; imgPreview.style.display='block'; };
      reader.readAsDataURL(file);
    });

    ['dragenter','dragover'].forEach((evt) =>
      imgDropArea?.addEventListener(evt, (e) => { 
        e.preventDefault(); 
        imgDropArea.classList.add('drag'); 
      })
    );

    ['dragleave','drop'].forEach((evt) =>
      imgDropArea?.addEventListener(evt, (e) => { 
        e.preventDefault(); 
        imgDropArea.classList.remove('drag'); 
      })
    );

    imgDropArea?.addEventListener('drop', e=>{
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f){ imgInput.files = e.dataTransfer.files; imgInput.dispatchEvent(new Event('change')); }
    });

    // SubmenÃº mobile
    const catsDrop = document.getElementById('catsDrop');
    const catsLink = document.getElementById('catsLink');
    catsLink.addEventListener('click', (e)=>{
      if (window.matchMedia('(max-width: 820px)').matches){
        e.preventDefault();
        const isOpen = catsDrop.classList.toggle('open');
        catsLink.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      }
    });
    document.addEventListener('click', (e)=>{
      if(!catsDrop.contains(e.target)){
        catsDrop.classList.remove('open');
        catsLink.setAttribute('aria-expanded','false');
      }
    });

    // ====== Ã‰xito centrado ======
    const successOverlay = document.getElementById('successOverlay');
    const successTitle   = document.getElementById('successTitle');
    const successText    = document.getElementById('successText');

    function showSuccess(message = 'Tu publicaciÃ³n se guardÃ³ correctamente.', redirUrl = 'index.html', delayMs = 1400) {
      successTitle.textContent = 'Â¡PublicaciÃ³n creada!';
      successText.textContent  = message;
      successOverlay.classList.add('show');
      document.body.classList.add('modal-open');
      setTimeout(()=>{ window.location.href = redirUrl; }, delayMs);
    }
    window.showSuccess = showSuccess;
  </script>

  <!-- SUPABASE: Auth + header -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    if (!window.sb) {
      window.sb = createClient(
        'https://imexctmcesopdfdebsgo.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZXhjdG1jZXNvcGRmZGVic2dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDczMDIsImV4cCI6MjA3NDg4MzMwMn0.g1lziVKAuUvMEOkYxJhe2D2z8PlwGJ6xcXo_SSpTj7Q'
      );
    }
    const sb = window.sb;

    const loginBtn = document.getElementById('loginBtn')
    const userWdg = document.getElementById('userWidget')
    const avatarEl = document.getElementById('userAvatar')
    const greetEl = document.getElementById('greeting')
    const userMenu = document.getElementById('userMenu')
    const logoutBtn = document.getElementById('logoutBtn')
    const loadingEl = document.getElementById('loading')
    const siteHeader = document.getElementById('siteHeader')
    const mainContent = document.getElementById('mainContent')
    const footer = document.querySelector('.site-footer')

    async function checkAuthAndRedirect() {
      const { data: { session } } = await sb.auth.getSession()
      if (!session) {
        const currentPage = encodeURIComponent(window.location.pathname + window.location.search);
        window.location.href = `login.html?return=${currentPage}`;
        return;
      }
      showContent();
      await refreshHeader();
    }

    function showContent() {
      loadingEl.style.display = 'none';
      siteHeader.style.display = 'block';
      mainContent.style.display = 'block';
      footer.style.display = 'block';
    }

    const initialsFrom = (n='',a='',e='')=>{
      const ini = (n.trim().split(/\s+/)[0]?.[0]||'') + (a.trim().split(/\s+/)[0]?.[0]||'')
      return (ini || (e?.[0]||'?')).toUpperCase()
    }
    const firstNameFrom = (n='',e='')=>{
      const f = n.trim().split(/\s+/)[0]
      return f || (e||'').split('@')[0]
    }

    async function refreshHeader(){
      const { data:{ session } } = await sb.auth.getSession()
      let nombre='', apellido='', email=session.user.email||''
      try{
        const { data: perfil } = await sb
          .from('usuario')
          .select('nombre, apellido, email')
          .eq('email', email)
          .maybeSingle()
        if(perfil){ nombre = perfil.nombre||''; apellido = perfil.apellido||''; }
      }catch(_){}
      avatarEl.textContent = initialsFrom(nombre, apellido, email)
      greetEl.textContent = `Hola, ${firstNameFrom(nombre, email)}!`
      loginBtn.classList.add('hidden')
      userWdg.classList.remove('hidden')
    }

    await checkAuthAndRedirect();

    userWdg.addEventListener('click', (e)=>{
      if(e.target.closest('#userMenu')) return
      userMenu.classList.toggle('hidden')
    })
    document.addEventListener('click', (e)=>{
      if(!userWdg.contains(e.target)) userMenu.classList.add('hidden')
    })
    logoutBtn.addEventListener('click', async (e)=>{
      e.preventDefault()
      await sb.auth.signOut()
      window.location.href = 'index.html'
    })
  </script>

  <!-- SUPABASE: crear PRODUCTO_BASE + PUBLICACION + FOTO -->
  <script type="module">
    const sbClient = window.sb;
    const BUCKET_NAME = 'publicaciones';

    const mapCatPub = (v)=> v === 'SelecciÃ³n' ? 'Seleccion' : v;
    const mapAuth   = (v)=> v === 'Replica'   ? 'RÃ©plica'   : 'Original';
    const mapEstado = (v)=> v === 'En conversaciÃ³n' ? 'En conversacion' : v;

    const sellForm = document.getElementById('sellForm');
    const sellFileInput = document.getElementById('imagen');

    sellForm.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const { data:{ session } } = await sbClient.auth.getSession();
      if(!session){ 
        alert('TenÃ©s que iniciar sesiÃ³n para publicar.'); 
        window.location.href = 'login.html'; 
        return;
      }

      const email = session.user.email;
      const { data: usuario, error: errUser } = await sbClient
        .from('usuario')
        .select('id_usuario, nombre, apellido, email')
        .eq('email', email)
        .maybeSingle();
      if(errUser){ console.error(errUser); alert('Error buscando tu usuario.'); return }
      if(!usuario){ alert('No se encontrÃ³ tu usuario en la tabla usuario (email).'); return }
      const id_usuario = usuario.id_usuario;

      const equipo = document.getElementById('equipo').value.trim();
      const titulo = document.getElementById('titulo').value.trim();
      const descripcion = document.getElementById('descripcion').value.trim();
      const precio = parseFloat(document.getElementById('precio').value);
      const moneda = document.getElementById('moneda').value;
      const condicion = document.getElementById('condicion').value;
      const autenticidad = mapAuth(document.getElementById('auth').value);
      const talle = document.getElementById('talle').value;
      const stock = parseInt(document.getElementById('stock').value, 10);

      if (!equipo || !titulo || Number.isNaN(precio) || Number.isNaN(stock)) {
        alert('CompletÃ¡ equipo, tÃ­tulo, precio y stock correctamente.');
        return;
      }

      const categoriaSel = document.querySelector('input[name="categoria"]:checked')?.value || 'Club';
      const categoria_pub = mapCatPub(categoriaSel);

      const estadoSel = document.querySelector('input[name="estado"]:checked')?.value || 'Activa';
      const estado_pub = mapEstado(estadoSel);

      if(!sellFileInput.files || !sellFileInput.files[0]){ alert('SubÃ­ al menos una imagen.'); return }
      const file = sellFileInput.files[0];

      const path = `${id_usuario}/${Date.now()}-${file.name}`;
      const { error: upErr } = await sbClient.storage.from(BUCKET_NAME)
        .upload(path, file, { upsert:false, contentType: file.type || 'image/jpeg' });
      if(upErr){ console.error(upErr); alert('Error subiendo imagen.'); return }
      const { data: pubUrl } = sbClient.storage.from(BUCKET_NAME).getPublicUrl(path);
      const fotoURL = pubUrl.publicUrl;

      let categoria_prod = null;
      if (categoria_pub === 'Club' || categoria_pub === 'Seleccion') {
        categoria_prod = categoria_pub;
      }

      // 1) producto_base
      const { data: prod, error: prodErr } = await sbClient
        .from('producto_base')
        .insert([{
          equipo: equipo,
          categoria: categoria_prod,      // enum categoria_prod (Club/Seleccion)
          nombre_public: titulo           // tÃ­tulo como nombre_public
        }])
        .select('id_producto')
        .single();

      if (prodErr) {
        console.error(prodErr);
        alert('Error creando el producto base.');
        return;
      }
      const id_producto = prod.id_producto;

      // 2) publicacion (incluye la nueva columna club)
      const pubRow = {
        id_usuario,
        id_producto,
        titulo,
        descripcion,
        precio,
        moneda,
        condicion,
        autenticidad,
        categoria: categoria_pub,  // enum categoria_pub_t (Club/Seleccion/Retro)
        talle,
        stock,
        estado: estado_pub,
        club: equipo               // para el catÃ¡logo
      };

      const { data: pub, error: pubErr } = await sbClient
        .from('publicacion')
        .insert([pubRow])
        .select('id_publicacion')
        .single();

      if (pubErr) {
        console.error(pubErr);
        alert('Error creando la publicaciÃ³n.');
        return;
      }
      const id_publicacion = pub.id_publicacion;

      // 3) foto
      const { error: fotoErr } = await sbClient
        .from('foto')
        .insert([{ id_publicacion, url: fotoURL, orden_foto: 1 }]);

      if (fotoErr) {
        console.error(fotoErr);
        alert('La publicaciÃ³n se creÃ³, pero fallÃ³ guardar la foto.');
        return;
      }

      // Ã‰xito âœ…
      window.showSuccess?.('Tu publicaciÃ³n se guardÃ³ correctamente.', 'index.html', 1400);
    });
  </script>

  <!-- === Notificaciones: SOLO el JS, sin HTML incrustado === -->
  <script type="module" src="scripts/notifications.js"></script>
</body>
</html>