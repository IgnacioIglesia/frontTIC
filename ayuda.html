<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ayuda â€” La Otra Tribuna</title>
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="stylesheet" href="styles/mobile.css" />
  <script src="scripts/mobile-nav.js" defer></script>
  <link rel="stylesheet" href="styles/user-widget.css" />
  <link rel="stylesheet" href="styles/notifications.css" />
  <link rel="icon" type="image/png" href="./assets/logo.png" />
  <style>
    /* Loading spinner */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      gap: 16px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Centrar el contenido */
    .track-full {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: calc(100vh - 200px);
      padding: 40px 20px;
    }
    .track-card {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    /* âœ… Fix de notificaciÃ³n */
    .notif-btn::before,
    .notif-btn::after {
      content: none !important;
      background: none !important;
    }

    .notif-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 8px;
      border: 1px solid var(--ring, #e5e7eb);
      background: #fff;
      padding: 0;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
    }

    .notif-badge[hidden] { display: none !important; }
  </style>
</head>
<body>
  <!-- ===== LOADING ===== -->
  <div id="loading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Verificando acceso...</p>
  </div>

  <!-- ===== HEADER ===== -->
  <header id="siteHeader" style="display:none;">
    <div class="top container">
      <div class="brand-wrap">
        <a href="index.html" class="logo-link" aria-label="Ir al inicio">
          <img class="logo" src="./assets/logo.png" alt="La Otra Tribuna" />
        </a>
      </div>

      <div class="search">
        <input type="search" placeholder="Buscar club o paÃ­sâ€¦" autocomplete="off" />
      </div>

      <div class="header-messages" id="headerMessage">Estamos para ayudarte</div>

      <div class="actions" style="display:flex;align-items:center;gap:12px;">
        <!-- ðŸ”” Notificaciones -->
        <div id="notifWrap" class="hidden" aria-live="polite">
          <button id="notifBtn" class="notif-btn" aria-label="Notificaciones" aria-haspopup="true" aria-expanded="false">
            ðŸ””
            <span id="notifBadge" class="notif-badge" hidden>0</span>
          </button>

          <div id="notifMenu" class="notif-menu hidden" role="menu" aria-label="Notificaciones">
            <div class="notif-head">
              <strong>Notificaciones</strong>
              <button id="notifMarkAll" class="linklike" type="button">Marcar todas como leÃ­das</button>
            </div>
            <ul id="notifList" class="notif-list" role="none"></ul>
            <div class="notif-foot">
              <a href="notificaciones.html" class="linklike">Ver todas</a>
            </div>
          </div>
        </div>

        <!-- BotÃ³n por defecto si NO hay sesiÃ³n -->
        <a id="loginBtn" href="login.html" class="btn-login">Iniciar sesiÃ³n</a>

        <!-- Widget usuario -->
        <div id="userWidget" class="user-widget hidden" aria-live="polite">
          <div id="userAvatar" class="user-avatar" title="Mi perfil"></div>
          <span id="greeting" class="user-greeting"></span>
          <div id="userMenu" class="user-menu hidden">
            <a href="perfil.html">ðŸ‘¤ Perfil</a>
            <a href="mis_publicaciones.html">ðŸ“Š Mis Publicaciones</a>
            <a href="mis-pedidos.html">ðŸ§¾ Mis pedidos</a>
            <a href="#" id="logoutBtn">ðŸšª Cerrar sesiÃ³n</a>
          </div>
        </div>
      </div>
    </div>

    <button class="burger" aria-expanded="false" aria-controls="mnav" aria-label="Abrir menÃº">
      <span>â‰¡</span>
    </button>

    <nav class="subnav">
      <div class="container subnav-inner">
        <div class="subnav-left">
          <a href="#ubicacion" class="loc-link" id="openLocation">
            <svg class="loc-ic" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22s7-6.46 7-12a7 7 0 1 0-14 0c0 5.54 7 12 7 12Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <span class="loc-line" id="locText">Enviar a <strong>Montevideo</strong></span>
          </a>
        </div>

        <div class="subnav-center">
          <div class="has-submenu" id="catsDrop">
            <a href="index.html" class="subnav-link" id="catsLink" aria-haspopup="true" aria-expanded="false">
              CategorÃ­as <span class="chev" aria-hidden="true">â–¾</span>
            </a>
            <div class="cat-submenu" id="catsMenu" role="menu" aria-label="CategorÃ­as">
              <a href="index.html?cat=club#catalogo">Club</a>
              <a href="index.html?cat=seleccion#catalogo">SelecciÃ³n</a>
              <a href="index.html?cat=retro#catalogo">Retro</a>
            </div>
          </div>
          <a href="ofertas.html" class="subnav-link">Ofertas</a>
          <a href="vender.html" class="subnav-link">Vender</a>
          <a href="rastrear.html" class="subnav-link">Rastrear Pedido</a>
        </div>

        <div class="subnav-right">
          <a href="favoritos.html" class="subnav-link">Favoritos</a>
          <a href="como-funciona.html" class="subnav-link">CÃ³mo funciona</a>
          <a href="autenticidad.html" class="subnav-link">Autenticidad</a>
          <a href="ayuda.html" class="subnav-link">Ayuda</a>
        </div>
      </div>
    </nav>

    <nav id="mnav" class="mnav" role="dialog" aria-modal="true" aria-label="MenÃº">
      <div class="mnav-head">
        <strong>MenÃº</strong>
        <button type="button" class="close-mnav" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="mnav-search">
        <input id="mq" type="search" placeholder="Buscar camisetasâ€¦" autocomplete="off" />
        <div id="msearchMenu" class="search-menu" hidden></div>
      </div>
      <div class="mnav-links">
        <a href="index.html">Inicio</a>
        <a href="ofertas.html">Ofertas</a>
        <a href="vender.html">Vender</a>
        <a href="rastrear.html">Rastrear Pedido</a>
        <a href="favoritos.html">Favoritos</a>
        <a href="como-funciona.html">CÃ³mo funciona</a>
        <a href="autenticidad.html">Autenticidad</a>
        <a href="ayuda.html">Ayuda</a>
      </div>
    </nav>

  <!-- Si la pÃ¡gina no lo tiene todavÃ­a: -->
  <div id="overlay" class="overlay"></div>

  </header>

  <!-- ===== CONTENIDO ===== -->
  <main class="track-full" id="mainContent" style="display:none;">
    <div class="track-card">
      <div class="track-title">
        <img src="./assets/imagen.png" alt="" style="width:28px;height:28px;border-radius:6px;">
        <h2 style="margin:0;font-size:18px">Ayuda</h2>
      </div>

      <form id="helpForm" class="track-form">
        <div class="field">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="Tu email" required />
        </div>

        <div class="field">
          <label for="order">N.Âº de pedido (opcional)</label>
          <input id="order" type="text" placeholder="Ej: ABC123456UY" />
        </div>

        <div class="field">
          <label for="message">Â¿QuÃ© ocurriÃ³?</label>
          <textarea id="message" placeholder="Contanos el problema con el mayor detalle posibleâ€¦" required></textarea>
        </div>

        <button class="btn primary" type="submit" style="width:100%;">Enviar</button>
      </form>

      <div id="helpResult" class="track-result" style="display:none"></div>
    </div>
  </main>

  <footer class="site-footer" style="display:none;">Â© <span id="year"></span> La Otra Tribuna.</footer>

  <script src="scripts/notifications.js" type="module"></script>

  <!-- ===== SUPABASE AUTH ===== -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = 'https://imexctmcesopdfdebsgo.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZXhjdG1jZXNvcGRmZGVic2dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDczMDIsImV4cCI6MjA3NDg4MzMwMn0.g1lziVKAuUvMEOkYxJhe2D2z8PlwGJ6xcXo_SSpTj7Q'
    if (!window.sb) window.sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    const supabase = window.sb

    const loginBtn = document.getElementById('loginBtn')
    const userWidget = document.getElementById('userWidget')
    const avatarEl = document.getElementById('userAvatar')
    const greetEl = document.getElementById('greeting')
    const userMenu = document.getElementById('userMenu')
    const logoutBtn = document.getElementById('logoutBtn')
    const loadingEl = document.getElementById('loading')
    const siteHeader = document.getElementById('siteHeader')
    const mainContent = document.getElementById('mainContent')
    const footer = document.querySelector('.site-footer')

    async function checkAuthAndRedirect() {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        const currentPage = encodeURIComponent(window.location.pathname + window.location.search)
        window.location.href = `login.html?return=${currentPage}`
        return
      }
      showContent()
      await refreshHeader()
    }

    function showContent() {
      loadingEl.style.display = 'none'
      siteHeader.style.display = 'block'
      mainContent.style.display = 'block'
      footer.style.display = 'block'
    }

    const initialsFrom = (n='', a='', e='') => ((n[0]||'')+(a[0]||e[0]||'?')).toUpperCase()
    const firstNameFrom = (n='', e='') => (n.trim().split(/\s+/)[0] || e.split('@')[0])

    async function refreshHeader(){
      const { data: { session } } = await supabase.auth.getSession()
      if (!session){
        userWidget.classList.add('hidden')
        loginBtn.classList.remove('hidden')
        return
      }
      const uid = session.user.id
      let nombre='', apellido='', email=session.user.email||''
      try{
        const { data: perfil } = await supabase
          .from('usuario')
          .select('nombre, apellido, email')
          .eq('id_auth', uid)
          .maybeSingle()
        if (perfil){
          nombre = perfil.nombre || ''
          apellido = perfil.apellido || ''
          email = perfil.email || email
        }
      }catch(_){}
      avatarEl.textContent = initialsFrom(nombre, apellido, email)
      greetEl.textContent  = `Hola, ${firstNameFrom(nombre, email)}!`
      loginBtn.classList.add('hidden')
      userWidget.classList.remove('hidden')
    }

    await checkAuthAndRedirect()
    userWidget.addEventListener('click', e => { if(!e.target.closest('#userMenu')) userMenu.classList.toggle('hidden') })
    document.addEventListener('click', e => { if(!userWidget.contains(e.target)) userMenu.classList.add('hidden') })
    logoutBtn.addEventListener('click', async e => { e.preventDefault(); await supabase.auth.signOut(); window.location.href = 'index.html' })
  </script>
</body>
</html>