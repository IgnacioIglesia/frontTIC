<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ayuda â€” La Otra Tribuna</title>
  <base href="https://la-otra-tribuna.netlify.app/" />
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="stylesheet" href="styles/user-widget.css" />
  <link rel="icon" type="image/png" href="./assets/logo.png" />
  <style>
    /* Loading spinner */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      gap: 16px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- ===== LOADING ===== -->
  <div id="loading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Verificando acceso...</p>
  </div>

  <!-- ===== HEADER ===== -->
  <header id="siteHeader" style="display:none;">
    <div class="top container">
      <div class="brand-wrap">
        <a href="index.html" class="logo-link" aria-label="Ir al inicio">
          <img class="logo" src="./assets/logo.png" alt="La Otra Tribuna">
        </a>
      </div>

      <div class="search">
        <input type="search" placeholder="Buscar club o paÃ­sâ€¦" autocomplete="off" />
      </div>

      <div class="header-messages" id="headerMessage">Estamos para ayudarte</div>

      <div class="actions" style="display:flex;align-items:center;gap:12px;">
        <!-- BotÃ³n por defecto si NO hay sesiÃ³n -->
        <a id="loginBtn" href="login.html" class="btn-login">Iniciar sesiÃ³n</a>
      
        <!-- Widget usuario (se muestra SOLO con sesiÃ³n) -->
        <div id="userWidget" class="user-widget hidden" aria-live="polite">
          <div id="userAvatar" class="user-avatar" title="Mi perfil"></div>
          <span id="greeting" class="user-greeting"></span>
          <!-- Dropdown -->
          <div id="userMenu" class="user-menu hidden">
            <a href="perfil.html">ðŸ‘¤ Perfil</a>
            <a href="#" id="logoutBtn">ðŸšª Cerrar sesiÃ³n</a>
          </div>
        </div>
      </div>
    </div>

    <nav class="subnav">
      <div class="container subnav-inner">
        <div class="subnav-left">
          <!-- botÃ³n/estado de ubicaciÃ³n -->
          <a href="#ubicacion" class="loc-link" id="openLocation">
            <svg class="loc-ic" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 22s7-6.46 7-12a7 7 0 1 0-14 0c0 5.54 7 12 7 12Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.6"/>
            </svg>
            <span class="loc-line" id="locText">Enviar a <strong>Montevideo</strong></span>
          </a>
        </div>
    
        <div class="subnav-center">
          <div class="has-submenu" id="catsDrop">
            <a href="index.html" class="subnav-link" id="catsLink" aria-haspopup="true" aria-expanded="false">
              CategorÃ­as <span class="chev" aria-hidden="true">â–¾</span>
            </a>
            <div class="cat-submenu" id="catsMenu" role="menu" aria-label="CategorÃ­as">
              <a href="index.html?cat=club#catalogo">Club</a>
              <a href="index.html?cat=seleccion#catalogo">SelecciÃ³n</a>
              <a href="index.html?cat=retro#catalogo">Retro</a>
            </div>
          </div>
          <a href="ofertas.html" class="subnav-link">Ofertas</a>
          <a href="vender.html" class="subnav-link">Vender</a>
          <a href="rastrear.html" class="subnav-link">Rastrear Pedido</a>
        </div>
    
        <div class="subnav-right">
          <a href="favoritos.html" class="subnav-link">Favoritos</a>
          <a href="como-funciona.html" class="subnav-link">CÃ³mo funciona</a>
          <a href="autenticidad.html" class="subnav-link">Autenticidad</a>
          <a href="ayuda.html" class="subnav-link">Ayuda</a>
        </div>
      </div>
    </nav>
  </header>

  <!-- Overlay + modal ubicaciÃ³n -->
  <div id="overlay" class="overlay"></div>
  <div id="locationModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3>Elige dÃ³nde recibir tus compras</h3>
        <button class="modal-close" id="closeLocation" aria-label="Cerrar">âœ•</button>
      </div>
      <form id="locForm" class="loc-form" autocomplete="off">
        <div class="field">
          <label for="departamento">Departamento</label>
          <select id="departamento" required>
            <option value="" selected>Elija una opciÃ³n</option>
          </select>
        </div>
        <div class="field">
          <label for="localidad">Localidad</label>
          <select id="localidad" required disabled>
            <option value="" selected>Elija una opciÃ³n</option>
          </select>
        </div>
        <div class="actions-row">
          <button type="button" class="btn" id="cancelLoc">Cancelar</button>
          <button type="submit" class="btn primary" id="acceptLoc" disabled>Aceptar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== CONTENIDO (SOLO PARA USUARIOS AUTENTICADOS) ===== -->
  <main class="track-full" id="mainContent" style="display:none;">
    <div class="track-card">
      <div class="track-title">
        <img src="./assets/imagen.png" alt="" style="width:28px;height:28px;border-radius:6px;">
        <h2 style="margin:0;font-size:18px">Ayuda</h2>
      </div>

      <form id="helpForm" class="track-form">
        <!-- Email primero -->
        <div class="field">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="Tu email" required>
        </div>

        <!-- NÂ° pedido opcional -->
        <div class="field">
          <label for="order">N.Âº de pedido (opcional)</label>
          <input id="order" type="text" placeholder="Ej: ABC123456UY">
        </div>

        <!-- DescripciÃ³n -->
        <div class="field">
          <label for="message">Â¿QuÃ© ocurriÃ³?</label>
          <textarea id="message" placeholder="Contanos el problema con el mayor detalle posibleâ€¦" required></textarea>
        </div>

        <button class="btn primary" type="submit">Enviar</button>
      </form>

      <div id="helpResult" class="track-result" style="display:none"></div>
    </div>
  </main>

  <footer class="site-footer" style="display:none;">Â© <span id="year"></span> La Otra Tribuna.</footer>

  <script>
    // ===== Footer dinÃ¡mico =====
    document.getElementById('year').textContent = new Date().getFullYear();

    // Fija el texto del mensaje del header
    document.getElementById('headerMessage').textContent = 'Estamos para ayudarte';

    // ===== UbicaciÃ³n (mismo storage que index/rastrear) =====
    const LOCATION_KEY = 'lot_location';
    const overlay = document.getElementById('overlay');
    const openLocationBtn = document.getElementById('openLocation');
    const locationModal = document.getElementById('locationModal');
    const closeLocationBtn = document.getElementById('closeLocation');
    const cancelLocBtn = document.getElementById('cancelLoc');
    const deptSel = document.getElementById('departamento');
    const locSel = document.getElementById('localidad');
    const acceptLocBtn = document.getElementById('acceptLoc');
    const locText = document.getElementById('locText');

    const DEPTS = {"Artigas": [
        "Artigas", "Bella UniÃ³n", "TomÃ¡s Gomensoro", "Baltasar Brum"
      ],
      "Canelones": [
        "Canelones", "Ciudad de la Costa", "Las Piedras", "Pando", "La Paz",
        "Progreso", "Santa LucÃ­a", "AtlÃ¡ntida", "Parque del Plata", "Sauce",
        "San RamÃ³n", "Empalme Olmos", "Toledo"
      ],
      "Cerro Largo": [
        "Melo", "RÃ­o Branco", "Fraile Muerto", "TupambaÃ©", "Isidoro NoblÃ­a"
      ],
      "Colonia": [
        "Colonia del Sacramento", "Carmelo", "Nueva Helvecia", "Juan Lacaze",
        "Rosario", "Tarariras", "OmbÃºes de Lavalle"
      ],
      "Durazno": [
        "Durazno", "SarandÃ­ del YÃ­", "Carmen", "Centenario"
      ],
      "Flores": [
        "Trinidad", "Ismael Cortinas"
      ],
      "Florida": [
        "Florida", "SarandÃ­ Grande", "CasupÃ¡", "25 de Mayo"
      ],
      "Lavalleja": [
        "Minas", "JosÃ© Pedro Varela", "SolÃ­s de Mataojo", "Mariscala"
      ],
      "Maldonado": [
        "Maldonado", "Punta del Este", "San Carlos", "PiriÃ¡polis",
        "Pan de AzÃºcar", "AiguÃ¡", "La Barra"
      ],
      "Montevideo": [
        "Montevideo" // se maneja por barrios normalmente
      ],
      "PaysandÃº": [
        "PaysandÃº", "GuichÃ³n", "Quebracho", "Piedras Coloradas"
      ],
      "RÃ­o Negro": [
        "Fray Bentos", "Young", "Nuevo BerlÃ­n", "San Javier"
      ],
      "Rivera": [
        "Rivera", "Tranqueras", "Minas de Corrales", "Vichadero", "MandubÃ­"
      ],
      "Rocha": [
        "Rocha", "Chuy", "Castillos", "Lascano", "La Paloma", "Punta del Diablo"
      ],
      "Salto": [
        "Salto", "ConstituciÃ³n", "BelÃ©n", "DaymÃ¡n", "San Antonio"
      ],
      "San JosÃ©": [
        "San JosÃ© de Mayo", "Ciudad del Plata", "Libertad", "Ecilda Paullier",
        "Delta El Tigre", "RaigÃ³n"
      ],
      "Soriano": [
        "Mercedes", "Dolores", "Cardona", "JosÃ© Enrique RodÃ³", "Palmitas"
      ],
      "TacuarembÃ³": [
        "TacuarembÃ³", "Paso de los Toros", "San Gregorio de Polanco",
        "Curtina", "Ansina"
      ],
      "Treinta y Tres": [
        "Treinta y Tres", "Vergara", "Santa Clara de Olimar", "Villa Sara"
      ]};

    function fillDept(){ Object.keys(DEPTS).forEach(d => deptSel.append(new Option(d,d))); }
    function renderLocationText(){
      const raw = localStorage.getItem(LOCATION_KEY);
      if(!raw){ locText.innerHTML = 'Ingresa tu <strong>ubicaciÃ³n</strong>'; return; }
      try{ const {loc} = JSON.parse(raw); locText.textContent = `Enviar a ${loc}`; } catch { locText.innerHTML = 'Ingresa tu <strong>ubicaciÃ³n</strong>'; }
    }
    function showOverlay(){ overlay.classList.add('show'); }
    function hideOverlay(){ overlay.classList.remove('show'); }
    function openLocation(){ locationModal.classList.add('open'); showOverlay(); }
    function closeLocation(){ locationModal.classList.remove('open'); hideOverlay(); }

    openLocationBtn.addEventListener('click', (e)=>{ e.preventDefault(); openLocation(); });
    closeLocationBtn?.addEventListener('click', closeLocation);
    cancelLocBtn?.addEventListener('click', closeLocation);
    overlay.addEventListener('click', closeLocation);

    deptSel.addEventListener('change', ()=>{
      const dept = deptSel.value;
      locSel.innerHTML = '<option value="" selected>Elija una opciÃ³n</option>';
      if(!dept){ locSel.disabled = true; acceptLocBtn.disabled = true; return; }
      DEPTS[dept].forEach(loc => locSel.append(new Option(loc,loc)));
      locSel.disabled = false; acceptLocBtn.disabled = true;
    });
    locSel.addEventListener('change', ()=> acceptLocBtn.disabled = !locSel.value);
    document.getElementById('locForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(!deptSel.value || !locSel.value) return;
      localStorage.setItem(LOCATION_KEY, JSON.stringify({dept:deptSel.value, loc:locSel.value}));
      renderLocationText(); closeLocation();
    });

    fillDept(); renderLocationText();

    // ===== Form Ayuda =====
    const form = document.getElementById('helpForm');
    const result = document.getElementById('helpResult');
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const order = document.getElementById('order').value.trim();
      const message = document.getElementById('message').value.trim();

      // (placeholder) mostrar confirmaciÃ³n
      result.style.display = 'block';
      result.innerHTML =
        `<strong>Â¡Gracias!</strong> Recibimos tu consulta.<br>
         <b>Email:</b> ${email}${order ? ` â€¢ <b>Pedido:</b> ${order}` : ''}<br>
         Te respondemos a la brevedad.`;
      form.reset();
    });

    // Sombra header al hacer scroll
    const siteHeaderElement = document.getElementById('siteHeader');
    const onScroll = ()=> siteHeaderElement.classList.toggle('is-scrolled', window.scrollY > 0);
    onScroll(); window.addEventListener('scroll', onScroll, {passive:true});
  </script>

  <!-- ===== SUPABASE: VERIFICACIÃ“N DE AUTENTICACIÃ“N ===== -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = 'https://imexctmcesopdfdebsgo.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZXhjdG1jZXNvcGRmZGVic2dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDczMDIsImV4cCI6MjA3NDg4MzMwMn0.g1lziVKAuUvMEOkYxJhe2D2z8PlwGJ6xcXo_SSpTj7Q'
    
    // Cliente global Ãºnico
    if (!window.sb) {
      window.sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    }
    const supabase = window.sb

    const loginBtn   = document.getElementById('loginBtn')
    const userWidget = document.getElementById('userWidget')
    const avatarEl   = document.getElementById('userAvatar')
    const greetEl    = document.getElementById('greeting')
    const userMenu   = document.getElementById('userMenu')
    const logoutBtn  = document.getElementById('logoutBtn')
    const loadingEl = document.getElementById('loading')
    const siteHeader = document.getElementById('siteHeader')
    const mainContent = document.getElementById('mainContent')
    const footer = document.querySelector('.site-footer')

    async function checkAuthAndRedirect() {
      const { data: { session } } = await supabase.auth.getSession()
      
      if (!session) {
        // No hay sesiÃ³n - redirigir inmediatamente a login
        const currentPage = encodeURIComponent(window.location.pathname + window.location.search);
        window.location.href = `login.html?return=${currentPage}`;
        return;
      }
      
      // Hay sesiÃ³n - mostrar contenido
      showContent();
      await refreshHeader();
    }

    function showContent() {
      loadingEl.style.display = 'none';
      siteHeader.style.display = 'block';
      mainContent.style.display = 'block';
      footer.style.display = 'block';
    }

    const initialsFrom = (nombre='', apellido='', email='')=>{
      const n = (nombre||'').trim().split(/\s+/)[0] || ''
      const a = (apellido||'').trim().split(/\s+/)[0] || ''
      const ini = (n[0]||'') + (a[0]||'')
      return (ini || (email[0]||'?')).toUpperCase()
    }
    const firstNameFrom = (nombre='', email='')=>{
      const n = (nombre||'').trim().split(/\s+/)[0]
      return n || (email || '').split('@')[0]
    }

    async function refreshHeader(){
      const { data: { session } } = await supabase.auth.getSession()
      if (!session){
        userWidget.classList.add('hidden')
        loginBtn.classList.remove('hidden')
        return
      }
      const uid = session.user.id
      let nombre = '', apellido = '', email = session.user.email || ''
      try{
        const { data: perfil } = await supabase
          .from('usuario')
          .select('nombre, apellido, email')
          .eq('id_auth', uid)
          .maybeSingle()
        if (perfil){
          nombre = perfil.nombre || session.user.user_metadata?.nombre || ''
          apellido = perfil.apellido || session.user.user_metadata?.apellido || ''
          email = perfil.email || email
        }else{
          nombre = session.user.user_metadata?.nombre || ''
          apellido = session.user.user_metadata?.apellido || ''
        }
      }catch(_){}

      avatarEl.textContent = initialsFrom(nombre, apellido, email)
      greetEl.textContent  = `Hola, ${firstNameFrom(nombre, email)}!`

      loginBtn.classList.add('hidden')
      userWidget.classList.remove('hidden')
    }

    // Verificar autenticaciÃ³n al cargar
    await checkAuthAndRedirect();

    // Configurar listeners del header
    userWidget.addEventListener('click', (e)=>{
      if(e.target.closest('#userMenu')) return
      userMenu.classList.toggle('hidden')
    })

    document.addEventListener('click', (e)=>{
      if(!userWidget.contains(e.target)){
        userMenu.classList.add('hidden')
      }
    })

    logoutBtn.addEventListener('click', async (e)=>{
      e.preventDefault()
      await supabase.auth.signOut()
      window.location.href = 'index.html'
    })
  </script>
</body>
</html>